document.addEventListener("DOMContentLoaded",function(){p(),k(),S()});function p(){document.querySelectorAll(".alert-dismissible").forEach(function(t){setTimeout(function(){new bootstrap.Alert(t).close()},3e3)})}function L(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}function y(e){return e.querySelectorAll('input[type="date"]').forEach(i=>{if(i.value===""){const n=i.getAttribute("name");i.setAttribute("data-original-name",n),i.removeAttribute("name")}}),!0}function v(e){if(e.value.trim()){e.classList.remove("is-invalid");const t=e.nextElementSibling;return t&&t.classList.contains("invalid-feedback")&&(t.textContent=""),!0}else{e.classList.add("is-invalid");const t=e.nextElementSibling;if(t&&t.classList.contains("invalid-feedback"))t.textContent="Nama profesional wajib diisi";else{const i=document.createElement("div");i.classList.add("invalid-feedback"),i.textContent="Nama profesional wajib diisi",e.parentNode.appendChild(i)}return!1}}function m(e){const t=e.value.trim();if(!t){e.classList.add("is-invalid");const n=e.nextElementSibling;if(n&&n.classList.contains("invalid-feedback"))n.textContent="Email wajib diisi";else{const a=document.createElement("div");a.classList.add("invalid-feedback"),a.textContent="Email wajib diisi",e.parentNode.appendChild(a)}return!1}if(!L(t)){e.classList.add("is-invalid");const n=e.nextElementSibling;if(n&&n.classList.contains("invalid-feedback"))n.textContent="Format email tidak valid";else{const a=document.createElement("div");a.classList.add("invalid-feedback"),a.textContent="Format email tidak valid",e.parentNode.appendChild(a)}return!1}e.classList.remove("is-invalid");const i=e.nextElementSibling;return i&&i.classList.contains("invalid-feedback")&&(i.textContent=""),!0}async function h(e,t,i){const n=e.value.trim();if(n===i){e.classList.remove("is-invalid");const a=e.nextElementSibling;return a&&a.classList.contains("invalid-feedback")&&(a.textContent=""),!0}if(!m(e))return!1;try{const a=new FormData;a.append("email_profesional",n),a.append("profesional_id",t),a.append("_token",document.querySelector('meta[name="csrf-token"]').getAttribute("content")),e.classList.add("is-loading");const o=await fetch("/profesional/profil/check-email-nidn-exists",{method:"POST",body:a});if(e.classList.remove("is-loading"),!o.ok)throw new Error("Network response was not ok");if((await o.json()).emailExists){e.classList.add("is-invalid");const r=e.nextElementSibling;if(r&&r.classList.contains("invalid-feedback"))r.textContent="Email sudah terdaftar dalam sistem.";else{const l=document.createElement("div");l.classList.add("invalid-feedback"),l.textContent="Email sudah terdaftar dalam sistem.",e.parentNode.appendChild(l)}return!1}else{e.classList.remove("is-invalid");const r=e.nextElementSibling;return r&&r.classList.contains("invalid-feedback")&&(r.textContent=""),!0}}catch(a){console.error("Error validating email:",a),e.classList.remove("is-loading"),e.classList.add("is-invalid");const o=e.nextElementSibling;if(o&&o.classList.contains("invalid-feedback"))o.textContent="Gagal memeriksa email. Silakan coba lagi.";else{const s=document.createElement("div");s.classList.add("invalid-feedback"),s.textContent="Gagal memeriksa email. Silakan coba lagi.",e.parentNode.appendChild(s)}return!1}}function k(){document.querySelectorAll('form[id^="form_edit_"]').forEach(t=>{const i=t.id.replace("form_edit_",""),n=document.getElementById(`edit_form_error_${i}`),a=document.getElementById(`modalProfesional${i}`);a&&(a.addEventListener("show.bs.modal",function(){console.log(`Modal ${a.id} fully shown`),t.querySelectorAll('input:not([type="file"]), select, textarea').forEach(l=>{l.setAttribute("data-original-value",l.value)})}),a.addEventListener("show.bs.modal",function(){console.log(`Modal ${a.id} opening`),g(t)}));const o=document.getElementById(`nama_profesional_${i}`),s=document.getElementById(`email_profesional_${i}`);o&&o.addEventListener("blur",function(){v(o)}),s&&s.addEventListener("blur",function(){m(s)}),t.addEventListener("submit",async function(r){r.preventDefault(),n&&(n.classList.add("d-none"),n.textContent=""),b(t);const l=t.querySelector('button[type="submit"]');l&&(l.disabled=!0,l.innerHTML='<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Menyimpan...');let c=!0;if(o){const d=v(o);c=c&&d}if(s&&s.value!==s.getAttribute("data-original-value")){let d=m(s);d&&(d=await h(s,i,s.getAttribute("data-original-value"))),c=c&&d}if(!c){l&&(l.disabled=!1,l.innerHTML="Simpan Perubahan"),n&&(n.textContent="Mohon periksa kembali data yang dimasukkan.",n.classList.remove("d-none"));const d=t.querySelector(".is-invalid");d&&(d.scrollIntoView({behavior:"smooth",block:"center"}),d.focus());return}y(t);const E=new FormData(t);try{const d=await fetch(t.action,{method:"POST",body:E,headers:{"X-Requested-With":"XMLHttpRequest"}}),u=await d.json();d.ok?window.location.reload():(u.errors?x(t,u.errors,i):n&&(n.textContent=u.message||"Terjadi kesalahan saat menyimpan data.",n.classList.remove("d-none")),l&&(l.disabled=!1,l.innerHTML="Simpan Perubahan"))}catch(d){console.error("Error submitting form:",d),n&&(n.textContent="Terjadi kesalahan saat menyimpan data. Silakan coba lagi.",n.classList.remove("d-none")),l&&(l.disabled=!1,l.innerHTML="Simpan Perubahan")}})})}function b(e){e.querySelectorAll(".is-invalid").forEach(i=>{i.classList.remove("is-invalid");const n=i.nextElementSibling;n&&n.classList.contains("invalid-feedback")&&(n.textContent="")})}function x(e,t,i){for(const o in t){const s=`${o}_${i}`,r=document.getElementById(s);if(r){r.classList.add("is-invalid");const l=r.nextElementSibling;if(l&&l.classList.contains("invalid-feedback"))l.textContent=Array.isArray(t[o])?t[o][0]:t[o];else{const c=document.createElement("div");c.classList.add("invalid-feedback"),c.textContent=Array.isArray(t[o])?t[o][0]:t[o],r.parentNode.appendChild(c)}}}const n=document.getElementById(`edit_form_error_${i}`);n&&(n.textContent="Terdapat kesalahan pada form. Mohon periksa kembali data yang dimasukkan.",n.classList.remove("d-none"));const a=e.querySelector(".is-invalid");a&&(a.scrollIntoView({behavior:"smooth",block:"center"}),a.focus())}function S(){document.querySelectorAll('.modal[id^="modalProfesional"]').forEach(t=>{t.id.replace("modalProfesional","");const i=t.querySelector("form");t.addEventListener("show.bs.modal",function(){console.log(`Modal ${t.id} opened - storing original values`),g(i)});const n=t.querySelector("button.btn-tutup");n&&n.addEventListener("click",function(){console.log(`Cancel button clicked in modal ${t.id}`),f(i)});const a=t.querySelector("button.btn-close");a&&a.addEventListener("click",function(){console.log(`Close button clicked in modal ${t.id}`),f(i)}),t.addEventListener("hidden.bs.modal",function(){console.log(`Modal ${t.id} hidden`),f(i)})})}function g(e){e._originalValues={},e.querySelectorAll('input:not([type="file"]), select, textarea').forEach(i=>{const n=i.id;e._originalValues[n]=i.value,i.setAttribute("data-original-value",i.value),console.log(`Stored original value for ${n}: ${i.value}`)})}function f(e){console.log("Resetting form to original values"),e._originalValues?e.querySelectorAll('input:not([type="file"]), select, textarea').forEach(o=>{const s=o.id;if(e._originalValues[s]!==void 0)o.value=e._originalValues[s],console.log(`Reset ${s} to ${e._originalValues[s]}`);else{const r=o.getAttribute("data-original-value");r!=null&&(o.value=r,console.log(`Reset ${s} to ${r} (from attribute)`))}}):e.querySelectorAll('input:not([type="file"]), select, textarea').forEach(o=>{const s=o.getAttribute("data-original-value");s!=null&&(o.value=s,console.log(`Reset ${o.id} to ${s} (from attribute)`))}),e.querySelectorAll('input[type="file"]').forEach(a=>{a.value=""}),e.querySelectorAll('input[type="password"]').forEach(a=>{a.value=""}),b(e);const n=e.querySelector(".alert-danger");n&&(n.classList.add("d-none"),n.textContent="")}
