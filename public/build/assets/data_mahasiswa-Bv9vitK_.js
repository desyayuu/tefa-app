document.addEventListener("DOMContentLoaded",function(){ae(),se(),Y(),Z()});function Y(){["profile_img_mahasiswa","cv_mahasiswa","ktp_mahasiswa","ktm_mahasiswa"].forEach(n=>{const i=document.getElementById(n);i&&i.addEventListener("change",function(){})})}function $(e){const n=e.id;e.classList.remove("is-invalid");const i=document.getElementById(n+"_error");if(i&&(i.textContent=""),!e.files||e.files.length===0)return!0;const a=e.files[0];console.log("File details:",{name:a.name,size:a.size,type:a.type,inputId:n});const t=2*1024*1024;if(a.size>t)return console.error("File too large:",a.size),e.classList.add("is-invalid"),i&&(i.textContent="Ukuran file maksimal 2MB"),!1;const s=a.name.toLowerCase().split(".").pop();let o=[],d="";switch(n){case"profile_img_mahasiswa":o=["jpg","jpeg","png","gif"],d="Format file tidak didukung. Format yang diizinkan: JPG, JPEG, PNG, GIF";break;case"cv_mahasiswa":o=["pdf","doc","docx"],d="Format file tidak didukung. Format yang diizinkan: PDF, DOC, DOCX";break;case"ktp_mahasiswa":case"ktm_mahasiswa":o=["pdf","jpg","jpeg","png"],d="Format file tidak didukung. Format yang diizinkan: PDF, JPG, JPEG, PNG";break}return console.log("File validation:",{extension:s,allowedExtensions:o,isAllowed:o.includes(s)}),o.includes(s)?!0:(e.classList.add("is-invalid"),i&&(i.textContent=d),!1)}function Z(){const e=document.getElementById("formEditMahasiswa");if(!e)return;ee(e),te(e);async function n(){let i=!0;document.querySelectorAll(".is-invalid").forEach(u=>u.classList.remove("is-invalid")),document.querySelectorAll(".invalid-feedback").forEach(u=>u.textContent="");const a=document.getElementById("form_mahasiswa_error");a&&a.classList.add("d-none");const t=document.getElementById("mahasiswa_id"),l=document.getElementById("nim_mahasiswa"),s=document.getElementById("email_mahasiswa");if(!t||!l||!s)return console.error("Required form elements not found"),!1;const o=t.value,d=l.getAttribute("data-original-value"),g=s.getAttribute("data-original-value"),f=document.getElementById("nama_mahasiswa");f&&!p(f)&&(i=!1),await O(l,o,d)||(i=!1),await z(s,o,g)||(i=!1);const _=document.getElementById("status_akun_mahasiswa");if(_&&!_.value){_.classList.add("is-invalid");const u=document.getElementById("status_akun_mahasiswa_error");u&&(u.textContent="Status akun harus dipilih"),i=!1}return["profile_img_mahasiswa","cv_mahasiswa","ktp_mahasiswa","ktm_mahasiswa"].forEach(u=>{const b=document.getElementById(u);b&&b.files.length>0&&($(b)||(i=!1))}),i}e.addEventListener("submit",async function(i){i.preventDefault();const a=e.querySelector('button[type="submit"]'),t=a.innerHTML;a.disabled=!0,a.innerHTML='<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Menyimpan...';try{await n()?e.submit():(a.disabled=!1,a.innerHTML=t,setTimeout(()=>{const s=e.querySelector(".is-invalid");s&&s.focus()},100))}catch(l){console.error("Form validation error:",l),a.disabled=!1,a.innerHTML=t;const s=document.getElementById("form_mahasiswa_error");s&&(s.textContent="Terjadi kesalahan saat validasi. Silakan coba lagi.",s.classList.remove("d-none"))}})}function ee(e){e.querySelectorAll('input:not([type="file"]), select, textarea').forEach(i=>{i.setAttribute("data-original-value",i.value)})}function te(e){const n=document.getElementById("mahasiswa_id"),i=document.getElementById("nim_mahasiswa"),a=document.getElementById("email_mahasiswa");if(!n||!i||!a){console.warn("Some required elements not found for real-time validation");return}const t=n.value,l=i.getAttribute("data-original-value"),s=a.getAttribute("data-original-value"),o=document.getElementById("nama_mahasiswa");o&&o.addEventListener("blur",function(){p(this)}),i&&i.addEventListener("blur",async function(){await O(this,t,l)}),a&&a.addEventListener("blur",async function(){await z(this,t,s)}),e.querySelectorAll("input, select, textarea").forEach(d=>{d.addEventListener("input",function(){this.classList.remove("is-invalid");const g=document.getElementById(this.id+"_error");g&&(g.textContent="")})})}function p(e){if(!e||!e.value.trim()){if(e){e.classList.add("is-invalid");const n=document.getElementById("nama_mahasiswa_error");n&&(n.textContent="Nama mahasiswa wajib diisi")}return!1}else{e.classList.remove("is-invalid");const n=document.getElementById("nama_mahasiswa_error");return n&&(n.textContent=""),!0}}function S(e){if(!e)return!1;const n=e.value.trim();if(!n){e.classList.add("is-invalid");const a=document.getElementById("nim_mahasiswa_error")||document.getElementById("nim_error");return a&&(a.textContent="NIM wajib diisi"),!1}if(!/^\d{10}$/.test(n)){e.classList.add("is-invalid");const a=document.getElementById("nim_mahasiswa_error")||document.getElementById("nim_error");return a&&(a.textContent="NIM harus berupa angka dan tepat 10 digit"),!1}e.classList.remove("is-invalid");const i=document.getElementById("nim_mahasiswa_error")||document.getElementById("nim_error");return i&&(i.textContent=""),!0}function A(e){if(!e)return!1;const n=e.value.trim(),i=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;if(!n){e.classList.add("is-invalid");const t=document.getElementById("email_mahasiswa_error")||document.getElementById("email_error");return t&&(t.textContent="Email wajib diisi"),!1}if(!i.test(n)){e.classList.add("is-invalid");const t=document.getElementById("email_mahasiswa_error")||document.getElementById("email_error");return t&&(t.textContent="Format email tidak valid"),!1}e.classList.remove("is-invalid");const a=document.getElementById("email_mahasiswa_error")||document.getElementById("email_error");return a&&(a.textContent=""),!0}function ae(){document.querySelectorAll(".alert-dismissible").forEach(function(n){setTimeout(function(){new bootstrap.Alert(n).close()},3e3)})}function ie(e){return new Promise((n,i)=>{const a=new FormData;a.append("email_mahasiswa",e),a.append("_token",document.querySelector('meta[name="csrf-token"]').getAttribute("content")),fetch("/koordinator/check-email-nim-exists",{method:"POST",body:a}).then(t=>{if(!t.ok)throw new Error("Network response was not ok");return t.json()}).then(t=>{n(t.emailExists)}).catch(t=>{i(t)})})}function ne(e){return new Promise((n,i)=>{const a=new FormData;a.append("nim_mahasiswa",e),a.append("_token",document.querySelector('meta[name="csrf-token"]').getAttribute("content")),fetch("/koordinator/check-email-nim-exists",{method:"POST",body:a}).then(t=>{if(!t.ok)throw new Error("Network response was not ok");return t.json()}).then(t=>{n(t.nimExists)}).catch(t=>{i(t)})})}async function O(e,n,i){if(!e)return!1;const a=e.value.trim();if(a===i){e.classList.remove("is-invalid");const t=e.nextElementSibling;return t&&t.classList.contains("invalid-feedback")&&(t.textContent=""),!0}if(!S(e))return!1;try{const t=new FormData;t.append("nim_mahasiswa",a),t.append("mahasiswa_id",n),t.append("_token",document.querySelector('meta[name="csrf-token"]').getAttribute("content")),e.classList.add("is-loading");const l=await fetch("/koordinator/check-email-nim-exists",{method:"POST",body:t});if(e.classList.remove("is-loading"),!l.ok)throw new Error("Network response was not ok");if((await l.json()).nimExists){e.classList.add("is-invalid");const o=e.nextElementSibling;if(o&&o.classList.contains("invalid-feedback"))o.textContent="NIM sudah terdaftar dalam sistem.";else{const d=document.createElement("div");d.classList.add("invalid-feedback"),d.textContent="NIM sudah terdaftar dalam sistem.",e.parentNode.appendChild(d)}return!1}else{e.classList.remove("is-invalid");const o=e.nextElementSibling;return o&&o.classList.contains("invalid-feedback")&&(o.textContent=""),!0}}catch(t){console.error("Error validating NIM:",t),e.classList.remove("is-loading"),e.classList.add("is-invalid");const l=e.nextElementSibling;if(l&&l.classList.contains("invalid-feedback"))l.textContent="Gagal memeriksa NIM. Silakan coba lagi.";else{const s=document.createElement("div");s.classList.add("invalid-feedback"),s.textContent="Gagal memeriksa NIM. Silakan coba lagi.",e.parentNode.appendChild(s)}return!1}}async function z(e,n,i){if(!e)return!1;const a=e.value.trim();if(a===i){e.classList.remove("is-invalid");const t=e.nextElementSibling;return t&&t.classList.contains("invalid-feedback")&&(t.textContent=""),!0}if(!A(e))return!1;try{const t=new FormData;t.append("email_mahasiswa",a),t.append("mahasiswa_id",n),t.append("_token",document.querySelector('meta[name="csrf-token"]').getAttribute("content")),e.classList.add("is-loading");const l=await fetch("/koordinator/check-email-nim-exists",{method:"POST",body:t});if(e.classList.remove("is-loading"),!l.ok)throw new Error("Network response was not ok");if((await l.json()).emailExists){e.classList.add("is-invalid");const o=e.nextElementSibling;if(o&&o.classList.contains("invalid-feedback"))o.textContent="Email sudah terdaftar dalam sistem.";else{const d=document.createElement("div");d.classList.add("invalid-feedback"),d.textContent="Email sudah terdaftar dalam sistem.",e.parentNode.appendChild(d)}return!1}else{e.classList.remove("is-invalid");const o=e.nextElementSibling;return o&&o.classList.contains("invalid-feedback")&&(o.textContent=""),!0}}catch(t){console.error("Error validating email:",t),e.classList.remove("is-loading"),e.classList.add("is-invalid");const l=e.nextElementSibling;if(l&&l.classList.contains("invalid-feedback"))l.textContent="Gagal memeriksa email. Silakan coba lagi.";else{const s=document.createElement("div");s.classList.add("invalid-feedback"),s.textContent="Gagal memeriksa email. Silakan coba lagi.",e.parentNode.appendChild(s)}return!1}}function se(){let e=[];const n=document.getElementById("btnTambahkanKeDaftarMahasiswa"),i=document.getElementById("daftarMahasiswa"),a=document.getElementById("mahasiswaJsonData"),t=document.getElementById("isSingle"),l=document.getElementById("emptyRow"),s=document.getElementById("formTambahMahasiswa"),o=document.getElementById("modalTambahMahasiswa"),d=document.getElementById("form_error"),g=document.getElementById("nama_mahasiswa"),f=document.getElementById("nim_mahasiswa"),_=document.getElementById("status_akun_mahasiswa"),E=document.getElementById("email_mahasiswa"),u=document.getElementById("password_mahasiswa"),b=document.getElementById("tanggal_lahir_mahasiswa"),x=document.getElementById("jenis_kelamin_mahasiswa"),L=document.getElementById("telepon_mahasiswa"),w=document.getElementById("profile_img_mahasiswa"),N=document.getElementById("nama_error"),v=document.getElementById("nim_error"),T=document.getElementById("status_akun_error"),y=document.getElementById("email_error"),D=document.getElementById("password_error"),F=document.getElementById("tanggal_lahir_error"),q=document.getElementById("jenis_kelamin_error"),j=document.getElementById("telepon_error"),P=document.getElementById("profile_img_error");J(),R(),o&&o.addEventListener("hidden.bs.modal",U),n&&n.addEventListener("click",Q),s&&s.addEventListener("submit",W);function J(){const r=document.getElementById("togglePassword");r&&u&&r.addEventListener("click",function(){const c=u.getAttribute("type")==="password"?"text":"password";u.setAttribute("type",c);const m=document.getElementById("eye-icon");m&&(c==="text"?(m.classList.remove("bi-eye"),m.classList.add("bi-eye-slash")):(m.classList.remove("bi-eye-slash"),m.classList.add("bi-eye")))})}function R(){g&&g.addEventListener("blur",function(){p(g)}),f&&f.addEventListener("blur",function(){S(f)}),E&&E.addEventListener("blur",function(){A(E)})}function K(){const r=e.length,c={nama_mahasiswa:g.value.trim(),nim_mahasiswa:f.value.trim(),status_akun_mahasiswa:_.value,email_mahasiswa:E.value.trim(),password_mahasiswa:u.value||f.value.trim(),tanggal_lahir_mahasiswa:b.value,jenis_kelamin_mahasiswa:x.value||null,telepon_mahasiswa:L.value.trim(),has_profile_img:w.files.length>0,profile_img_name:w.files.length>0?w.files[0].name:""};if(e.push(c),a.value=JSON.stringify(e),w.files.length>0){const m=document.createElement("input");m.type="file",m.name=`profile_img_mahasiswa_${r}`,m.classList.add("d-none"),m.setAttribute("data-mahasiswa-index",r);const k=new DataTransfer;k.items.add(w.files[0]),m.files=k.files,s.appendChild(m)}V()}function V(){l&&l.remove(),i.innerHTML="",e.forEach((r,c)=>{const m=document.createElement("tr"),k=r.has_profile_img?`<i class="bi bi-image text-success"></i> ${r.profile_img_name}`:"No image";m.innerHTML=`
                <td>${r.nama_mahasiswa}</td>
                <td>${r.nim_mahasiswa}</td>
                <td>${r.email_mahasiswa}</td>
                <td>${r.status_akun_mahasiswa}</td>
                <td>${k}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger" data-index="${c}">Hapus</button>
                </td>
            `;const C=m.querySelector("button[data-index]");C&&C.addEventListener("click",function(){const h=parseInt(this.getAttribute("data-index")),H=s.querySelector(`input[name="profile_img_mahasiswa_${h}"]`);H&&H.remove(),e.splice(h,1),a.value=JSON.stringify(e),s.querySelectorAll("input[data-mahasiswa-index]").forEach(I=>{const M=parseInt(I.getAttribute("data-mahasiswa-index"));M>h&&(I.name=`profile_img_mahasiswa_${M-1}`,I.setAttribute("data-mahasiswa-index",M-1))}),V(),e.length===0&&(i.innerHTML=`
                            <tr id="emptyRow">
                                <td colspan="6" class="text-center">Belum ada mahasiswa yang ditambahkan ke daftar</td>
                            </tr>
                        `)}),i.appendChild(m)})}function G(){g&&(g.value=""),f&&(f.value=""),_&&(_.value="Active"),E&&(E.value=""),u&&(u.value=""),b&&(b.value=""),x&&(x.value=""),L&&(L.value=""),w&&(w.value=""),B()}function B(){d&&(d.classList.add("d-none"),d.textContent=""),s&&s.querySelectorAll(".is-invalid").forEach(c=>{c.classList.remove("is-invalid")}),N&&(N.textContent=""),v&&(v.textContent=""),T&&(T.textContent=""),y&&(y.textContent=""),D&&(D.textContent=""),F&&(F.textContent=""),q&&(q.textContent=""),j&&(j.textContent=""),P&&(P.textContent="")}function U(){G(),B(),e=[],a&&(a.value="[]"),t&&(t.value="1"),s.querySelectorAll("input[data-mahasiswa-index]").forEach(c=>c.remove()),i&&(i.innerHTML=`
                <tr id="emptyRow">
                    <td colspan="6" class="text-center">Belum ada mahasiswa yang ditambahkan ke daftar</td>
                </tr>
            `)}async function X(){let r=!0;B(),p(g)||(r=!1),S(f)||(r=!1),A(E)||(r=!1);const c=f.value.trim(),m=E.value.trim();if(e.some(h=>h.nim_mahasiswa===c)&&(f.classList.add("is-invalid"),v&&(v.textContent="NIM sudah ada dalam daftar yang akan ditambahkan."),r=!1),e.some(h=>h.email_mahasiswa===m)&&(E.classList.add("is-invalid"),y&&(y.textContent="Email sudah ada dalam daftar yang akan ditambahkan."),r=!1),r&&c)try{await ne(c)&&(f.classList.add("is-invalid"),v&&(v.textContent="NIM sudah terdaftar dalam sistem."),r=!1)}catch(h){console.error("Error checking NIM:",h),f.classList.add("is-invalid"),v&&(v.textContent="Gagal memeriksa NIM. Silakan coba lagi."),r=!1}if(r&&m)try{await ie(m)&&(E.classList.add("is-invalid"),y&&(y.textContent="Email sudah terdaftar dalam sistem."),r=!1)}catch(h){console.error("Error checking email:",h),E.classList.add("is-invalid"),y&&(y.textContent="Gagal memeriksa email. Silakan coba lagi."),r=!1}return w&&w.files.length>0&&($(w)||(r=!1)),r}async function Q(){if(n){n.disabled=!0,n.innerHTML='<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Memeriksa...';try{await X()&&(K(),G(),t&&(t.value="0"))}catch(r){console.error("Validation error:",r),d&&(d.textContent="Terjadi kesalahan saat validasi. Silakan coba lagi.",d.classList.remove("d-none"))}finally{n.disabled=!1,n.innerHTML="Tambahkan ke Daftar"}}}async function W(r){if(r.preventDefault(),e.length>0||t&&t.value==="1"){const c=s.querySelector('button[type="submit"]');c&&(c.disabled=!0,c.innerHTML='<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Menyimpan...'),s.submit()}else d&&(d.textContent="Belum ada mahasiswa yang ditambahkan ke daftar.",d.classList.remove("d-none"))}}
