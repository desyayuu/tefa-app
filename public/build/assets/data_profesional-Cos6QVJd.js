document.addEventListener("DOMContentLoaded",function(){W(),ee(),te(),ae()});function W(){document.querySelectorAll(".alert-dismissible").forEach(function(t){setTimeout(function(){new bootstrap.Alert(t).close()},3e3)})}function N(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}function Q(e){return new Promise((t,i)=>{const n=new FormData;n.append("email_profesional",e),n.append("_token",document.querySelector('meta[name="csrf-token"]').getAttribute("content")),fetch("/koordinator/check-email-profesional-exists",{method:"POST",body:n}).then(a=>{if(!a.ok)throw new Error("Network response was not ok");return a.json()}).then(a=>{t(a.emailExists)}).catch(a=>{i(a)})})}function Y(e){return e.querySelectorAll('input[type="date"]').forEach(i=>{if(i.value===""){const n=i.getAttribute("name");i.setAttribute("data-original-name",n),i.removeAttribute("name")}}),!0}function I(e){if(e.value.trim()){e.classList.remove("is-invalid");const t=e.nextElementSibling;return t&&t.classList.contains("invalid-feedback")&&(t.textContent=""),!0}else{e.classList.add("is-invalid");const t=e.nextElementSibling;if(t&&t.classList.contains("invalid-feedback"))t.textContent="Nama profesional wajib diisi";else{const i=document.createElement("div");i.classList.add("invalid-feedback"),i.textContent="Nama profesional wajib diisi",e.parentNode.appendChild(i)}return!1}}function L(e){const t=e.value.trim();if(!t){e.classList.add("is-invalid");const n=e.nextElementSibling;if(n&&n.classList.contains("invalid-feedback"))n.textContent="Email wajib diisi";else{const a=document.createElement("div");a.classList.add("invalid-feedback"),a.textContent="Email wajib diisi",e.parentNode.appendChild(a)}return!1}if(!N(t)){e.classList.add("is-invalid");const n=e.nextElementSibling;if(n&&n.classList.contains("invalid-feedback"))n.textContent="Format email tidak valid";else{const a=document.createElement("div");a.classList.add("invalid-feedback"),a.textContent="Format email tidak valid",e.parentNode.appendChild(a)}return!1}e.classList.remove("is-invalid");const i=e.nextElementSibling;return i&&i.classList.contains("invalid-feedback")&&(i.textContent=""),!0}async function Z(e,t,i){const n=e.value.trim();if(n===i){e.classList.remove("is-invalid");const a=e.nextElementSibling;return a&&a.classList.contains("invalid-feedback")&&(a.textContent=""),!0}if(!L(e))return!1;try{const a=new FormData;a.append("email_profesional",n),a.append("profesional_id",t),a.append("_token",document.querySelector('meta[name="csrf-token"]').getAttribute("content")),e.classList.add("is-loading");const r=await fetch("/koordinator/check-email-profesional-exists",{method:"POST",body:a});if(e.classList.remove("is-loading"),!r.ok)throw new Error("Network response was not ok");if((await r.json()).emailExists){e.classList.add("is-invalid");const c=e.nextElementSibling;if(c&&c.classList.contains("invalid-feedback"))c.textContent="Email sudah terdaftar dalam sistem.";else{const s=document.createElement("div");s.classList.add("invalid-feedback"),s.textContent="Email sudah terdaftar dalam sistem.",e.parentNode.appendChild(s)}return!1}else{e.classList.remove("is-invalid");const c=e.nextElementSibling;return c&&c.classList.contains("invalid-feedback")&&(c.textContent=""),!0}}catch(a){console.error("Error validating email:",a),e.classList.remove("is-loading"),e.classList.add("is-invalid");const r=e.nextElementSibling;if(r&&r.classList.contains("invalid-feedback"))r.textContent="Gagal memeriksa email. Silakan coba lagi.";else{const o=document.createElement("div");o.classList.add("invalid-feedback"),o.textContent="Gagal memeriksa email. Silakan coba lagi.",e.parentNode.appendChild(o)}return!1}}function ee(){let e=[];const t=document.getElementById("btnTambahkanKeDaftarProfesional"),i=document.getElementById("daftarProfesional"),n=document.getElementById("profesionalJsonData"),a=document.getElementById("isSingle"),r=document.getElementById("emptyRow"),o=document.getElementById("formTambahProfesional"),c=document.getElementById("modalTambahProfesional");document.getElementById("btnSimpan");const s=document.getElementById("form_error"),m=document.getElementById("nama_profesional"),y=document.getElementById("status_akun_profesional"),l=document.getElementById("email_profesional"),b=document.getElementById("password_profesional"),x=document.getElementById("tanggal_lahir_profesional"),_=document.getElementById("jenis_kelamin_profesional"),C=document.getElementById("telepon_profesional"),p=document.getElementById("profile_img_profesional"),h=document.getElementById("nama_error"),T=document.getElementById("status_akun_error"),g=document.getElementById("email_error"),P=document.getElementById("password_error"),$=document.getElementById("tanggal_lahir_error"),M=document.getElementById("jenis_kelamin_error"),q=document.getElementById("telepon_error"),E=document.getElementById("profile_img_error");O(),J(),c&&c.addEventListener("hidden.bs.modal",G),t&&t.addEventListener("click",X),o&&o.addEventListener("submit",U);function O(){const d=document.getElementById("togglePassword");d&&b&&d.addEventListener("click",function(){const f=b.getAttribute("type")==="password"?"text":"password";b.setAttribute("type",f);const u=document.getElementById("eye-icon");u&&(f==="text"?(u.classList.remove("bi-eye"),u.classList.add("bi-eye-slash")):(u.classList.remove("bi-eye-slash"),u.classList.add("bi-eye")))})}function J(){m&&m.addEventListener("blur",function(){I(m)}),l&&l.addEventListener("blur",function(){L(l)})}function K(){const d=e.length,f={nama_profesional:m.value.trim(),status_akun_profesional:y.value,email_profesional:l.value.trim(),password_profesional:b.value||"password123",tanggal_lahir_profesional:x.value,jenis_kelamin_profesional:_.value||null,telepon_profesional:C.value.trim(),has_profile_img:p.files.length>0,profile_img_name:p.files.length>0?p.files[0].name:""};if(e.push(f),n.value=JSON.stringify(e),p.files.length>0){const u=document.createElement("input");u.type="file",u.name=`profile_img_profesional_${d}`,u.classList.add("d-none"),u.setAttribute("data-profesional-index",d);const v=new DataTransfer;v.items.add(p.files[0]),u.files=v.files,o.appendChild(u)}D()}function D(){r&&r.remove(),i.innerHTML="",e.forEach((d,f)=>{const u=document.createElement("tr"),v=d.has_profile_img?`<i class="bi bi-image text-success"></i> ${d.profile_img_name}`:"No image";u.innerHTML=`
                <td>${d.nama_profesional}</td>
                <td>${d.email_profesional}</td>
                <td>${d.status_akun_profesional}</td>
                <td>${v}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger" data-index="${f}">Hapus</button>
                </td>
            `;const j=u.querySelector("button[data-index]");j&&j.addEventListener("click",function(){const S=parseInt(this.getAttribute("data-index")),F=o.querySelector(`input[name="profile_img_profesional_${S}"]`);F&&F.remove(),e.splice(S,1),n.value=JSON.stringify(e),o.querySelectorAll("input[data-profesional-index]").forEach(w=>{const A=parseInt(w.getAttribute("data-profesional-index"));A>S&&(w.name=`profile_img_profesional_${A-1}`,w.setAttribute("data-profesional-index",A-1))}),D(),e.length===0&&(i.innerHTML=`
                            <tr id="emptyRow">
                                <td colspan="6" class="text-center">Belum ada profesional yang ditambahkan ke daftar</td>
                            </tr>
                        `)}),i.appendChild(u)})}function V(){m&&(m.value=""),y&&(y.value="Active"),l&&(l.value=""),b&&(b.value=""),x&&(x.value=""),_&&(_.value=""),C&&(C.value=""),p&&(p.value=""),k()}function k(){s&&(s.classList.add("d-none"),s.textContent=""),o&&o.querySelectorAll(".is-invalid").forEach(f=>{f.classList.remove("is-invalid")}),h&&(h.textContent=""),T&&(T.textContent=""),g&&(g.textContent=""),P&&(P.textContent=""),$&&($.textContent=""),M&&(M.textContent=""),q&&(q.textContent=""),E&&(E.textContent="")}function G(){V(),k(),e=[],n&&(n.value="[]"),a&&(a.value="1"),o.querySelectorAll("input[data-profesional-index]").forEach(f=>f.remove()),i&&(i.innerHTML=`
                <tr id="emptyRow">
                    <td colspan="6" class="text-center">Belum ada profesional yang ditambahkan ke daftar</td>
                </tr>
            `)}async function z(){let d=!0;if(k(),m&&!m.value.trim()&&(m.classList.add("is-invalid"),h&&(h.textContent="Nama profesional wajib diisi"),d=!1),l&&!l.value.trim())l.classList.add("is-invalid"),g&&(g.textContent="Email wajib diisi"),d=!1;else if(l&&!N(l.value.trim()))l.classList.add("is-invalid"),g&&(g.textContent="Format email tidak valid"),d=!1;else if(l){const f=l.value.trim();if(e.some(v=>v.email_profesional===f))l.classList.add("is-invalid"),g&&(g.textContent="Email sudah ada di daftar yang akan ditambahkan"),d=!1;else{l.classList.add("is-loading");try{const v=await Q(f);l.classList.remove("is-loading"),v&&(l.classList.add("is-invalid"),g&&(g.textContent="Email sudah terdaftar di database",g.style.display="block"),d=!1)}catch(v){console.error("Error checking email:",v),l.classList.remove("is-loading"),s&&(s.textContent="Terjadi kesalahan saat memeriksa email. Silakan coba lagi.",s.classList.remove("d-none")),d=!1}}}if(p&&p.files.length>0){const f=p.files[0],u=f.size/1024/1024;["image/jpeg","image/png","image/jpg","image/gif"].includes(f.type)?u>2&&(p.classList.add("is-invalid"),E&&(E.textContent="Ukuran file terlalu besar. Maksimal 2MB"),d=!1):(p.classList.add("is-invalid"),E&&(E.textContent="Format file tidak valid. Gunakan jpeg, png, jpg, atau gif"),d=!1)}return d}async function X(){k(),t.disabled=!0,t.innerHTML='<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Memeriksa...';try{const d=await z();if(t.disabled=!1,t.innerHTML="Tambahkan ke Daftar",!d)return;K(),V(),a&&(a.value="0")}catch(d){console.error("Validation error:",d),t.disabled=!1,t.innerHTML="Tambahkan ke Daftar",s&&(s.textContent="Terjadi kesalahan saat validasi. Silakan coba lagi.",s.classList.remove("d-none"))}}async function U(d){if(d.preventDefault(),e.length>0||a.value==="1"){const f=o.querySelector('button[type="submit"]');f&&(f.disabled=!0,f.innerHTML='<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Menyimpan...'),o.submit()}else s&&(s.textContent="Belum ada profesional yang ditambahkan ke daftar.",s.classList.remove("d-none"))}}function te(){document.querySelectorAll('form[id^="form_edit_"]').forEach(t=>{const i=t.id.replace("form_edit_",""),n=document.getElementById(`edit_form_error_${i}`),a=document.getElementById(`modalProfesional${i}`);a&&(a.addEventListener("show.bs.modal",function(){console.log(`Modal ${a.id} fully shown`),t.querySelectorAll('input:not([type="file"]), select, textarea').forEach(s=>{s.setAttribute("data-original-value",s.value)})}),a.addEventListener("show.bs.modal",function(){console.log(`Modal ${a.id} opening`),R(t)}));const r=document.getElementById(`nama_profesional_${i}`),o=document.getElementById(`email_profesional_${i}`);r&&r.addEventListener("blur",function(){I(r)}),o&&o.addEventListener("blur",function(){L(o)}),t.addEventListener("submit",async function(c){c.preventDefault(),n&&(n.classList.add("d-none"),n.textContent=""),H(t);const s=t.querySelector('button[type="submit"]');s&&(s.disabled=!0,s.innerHTML='<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Menyimpan...');let m=!0;if(r){const l=I(r);m=m&&l}if(o&&o.value!==o.getAttribute("data-original-value")){let l=L(o);l&&(l=await Z(o,i,o.getAttribute("data-original-value"))),m=m&&l}if(!m){s&&(s.disabled=!1,s.innerHTML="Simpan Perubahan"),n&&(n.textContent="Mohon periksa kembali data yang dimasukkan.",n.classList.remove("d-none"));const l=t.querySelector(".is-invalid");l&&(l.scrollIntoView({behavior:"smooth",block:"center"}),l.focus());return}Y(t);const y=new FormData(t);try{const l=await fetch(t.action,{method:"POST",body:y,headers:{"X-Requested-With":"XMLHttpRequest"}}),b=await l.json();l.ok?window.location.reload():(b.errors?ne(t,b.errors,i):n&&(n.textContent=b.message||"Terjadi kesalahan saat menyimpan data.",n.classList.remove("d-none")),s&&(s.disabled=!1,s.innerHTML="Simpan Perubahan"))}catch(l){console.error("Error submitting form:",l),n&&(n.textContent="Terjadi kesalahan saat menyimpan data. Silakan coba lagi.",n.classList.remove("d-none")),s&&(s.disabled=!1,s.innerHTML="Simpan Perubahan")}})})}function H(e){e.querySelectorAll(".is-invalid").forEach(i=>{i.classList.remove("is-invalid");const n=i.nextElementSibling;n&&n.classList.contains("invalid-feedback")&&(n.textContent="")})}function ne(e,t,i){for(const r in t){const o=`${r}_${i}`,c=document.getElementById(o);if(c){c.classList.add("is-invalid");const s=c.nextElementSibling;if(s&&s.classList.contains("invalid-feedback"))s.textContent=Array.isArray(t[r])?t[r][0]:t[r];else{const m=document.createElement("div");m.classList.add("invalid-feedback"),m.textContent=Array.isArray(t[r])?t[r][0]:t[r],c.parentNode.appendChild(m)}}}const n=document.getElementById(`edit_form_error_${i}`);n&&(n.textContent="Terdapat kesalahan pada form. Mohon periksa kembali data yang dimasukkan.",n.classList.remove("d-none"));const a=e.querySelector(".is-invalid");a&&(a.scrollIntoView({behavior:"smooth",block:"center"}),a.focus())}function ae(){document.querySelectorAll('.modal[id^="modalProfesional"]').forEach(t=>{t.id.replace("modalProfesional","");const i=t.querySelector("form");t.addEventListener("show.bs.modal",function(){console.log(`Modal ${t.id} opened - storing original values`),R(i)});const n=t.querySelector("button.btn-tutup");n&&n.addEventListener("click",function(){console.log(`Cancel button clicked in modal ${t.id}`),B(i)});const a=t.querySelector("button.btn-close");a&&a.addEventListener("click",function(){console.log(`Close button clicked in modal ${t.id}`),B(i)}),t.addEventListener("hidden.bs.modal",function(){console.log(`Modal ${t.id} hidden`),B(i)})})}function R(e){e._originalValues={},e.querySelectorAll('input:not([type="file"]), select, textarea').forEach(i=>{const n=i.id;e._originalValues[n]=i.value,i.setAttribute("data-original-value",i.value),console.log(`Stored original value for ${n}: ${i.value}`)})}function B(e){console.log("Resetting form to original values"),e._originalValues?e.querySelectorAll('input:not([type="file"]), select, textarea').forEach(r=>{const o=r.id;if(e._originalValues[o]!==void 0)r.value=e._originalValues[o],console.log(`Reset ${o} to ${e._originalValues[o]}`);else{const c=r.getAttribute("data-original-value");c!=null&&(r.value=c,console.log(`Reset ${o} to ${c} (from attribute)`))}}):e.querySelectorAll('input:not([type="file"]), select, textarea').forEach(r=>{const o=r.getAttribute("data-original-value");o!=null&&(r.value=o,console.log(`Reset ${r.id} to ${o} (from attribute)`))}),e.querySelectorAll('input[type="file"]').forEach(a=>{a.value=""}),e.querySelectorAll('input[type="password"]').forEach(a=>{a.value=""}),H(e);const n=e.querySelector(".alert-danger");n&&(n.classList.add("d-none"),n.textContent="")}
