document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll(".alert-dismissible").forEach(function(g){setTimeout(function(){new bootstrap.Alert(g).close()},3e3)}),R()});function R(){let r=[];const g=document.getElementById("btnTambahkanKeDaftar");document.getElementById("btnSimpan");const y=document.getElementById("daftarMitra"),B=document.getElementById("mitraJsonData"),d=document.getElementById("isSingle"),v=document.getElementById("emptyRow"),k=document.getElementById("formTambahData"),w=document.getElementById("modalTambahData");if(!g||!y)return;const m=document.getElementById("nama_mitra"),c=document.getElementById("email_mitra"),u=document.getElementById("telepon_mitra"),f=document.getElementById("alamat_mitra"),E=document.getElementById("nama_mitra_error"),o=document.getElementById("email_mitra_error"),h=document.getElementById("telepon_mitra_error"),b=document.getElementById("alamat_mitra_error"),p=document.getElementById("form_error");w&&w.addEventListener("show.bs.modal",function(){T(),_(),r=[],x(),L(),d&&(d.value="1")}),g.addEventListener("click",async function(){_();const e=m.value.trim(),t=c.value.trim(),n=u.value.trim(),a=f.value.trim();let i=!0;e||(s(E,"Nama mitra harus diisi"),i=!1),t?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)?r.some(I=>I.email_mitra===t)?(s(o,"Email sudah ada di daftar mitra"),i=!1):await S(t)&&(s(o,"Email sudah terdaftar"),i=!1):(s(o,"Format email tidak valid"),i=!1):(s(o,"Email harus diisi"),i=!1),n&&!/^\d+$/.test(n)&&(s(h,"Telepon hanya boleh berisi angka"),i=!1),a&&(i=!0),i&&(r.push({nama_mitra:e,email_mitra:t,telepon_mitra:n,alamat_mitra:a,id:Date.now()}),x(),L(),T(),_(),m.focus(),d.value="0")}),k&&k.addEventListener("submit",function(e){if(_(),d.value==="1"){const t=m.value.trim(),n=c.value.trim(),a=u.value.trim(),i=f.value.trim();let l=!0;if(t||(s(E,"Nama mitra harus diisi"),l=!1),n?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n)||(s(o,"Format email tidak valid"),l=!1):(s(o,"Email harus diisi"),l=!1),a||(s(h,"Telepon harus diisi"),l=!1),i||(s(b,"Alamat harus diisi"),l=!1),!l)return e.preventDefault(),!1;const D=[{nama_mitra:t,email_mitra:n,telepon_mitra:a,alamat_mitra:i}];B.value=JSON.stringify(D)}else if(r.length===0)return e.preventDefault(),s(p,"Belum ada data mitra yang ditambahkan ke daftar"),!1;return!0});function x(){y.querySelectorAll("tr:not(#emptyRow)").forEach(t=>t.remove()),r.length===0?v&&(v.style.display="table-row"):(v&&(v.style.display="none"),r.forEach((t,n)=>{const a=document.createElement("tr");a.innerHTML=`
                    <td>${t.nama_mitra}</td>
                    <td>${t.email_mitra}</td>
                    <td>${t.telepon_mitra}</td>
                    <td>${t.alamat_mitra}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-danger btn-hapus-item" data-id="${t.id}">
                            Hapus
                        </button>
                    </td>
                `,y.appendChild(a)}),document.querySelectorAll(".btn-hapus-item").forEach(t=>{t.addEventListener("click",function(){const n=parseInt(this.getAttribute("data-id"));r=r.filter(a=>a.id!==n),x(),L(),r.length===0&&(d.value="1")})}))}function L(){const e=r.map(({nama_mitra:t,email_mitra:n,telepon_mitra:a,alamat_mitra:i})=>({nama_mitra:t,email_mitra:n,telepon_mitra:a,alamat_mitra:i}));B.value=JSON.stringify(e)}function T(){m.value="",c.value="",u.value="",f.value=""}function _(){E&&(E.textContent=""),o&&(o.textContent=""),h&&(h.textContent=""),b&&(b.textContent=""),p&&(p.textContent="",p.classList.add("d-none")),m.classList.remove("is-invalid"),c.classList.remove("is-invalid"),u.classList.remove("is-invalid"),f.classList.remove("is-invalid")}function s(e,t){e&&(e.textContent=t,e===E&&m.classList.add("is-invalid"),e===o&&c.classList.add("is-invalid"),e===h&&u.classList.add("is-invalid"),e===b&&f.classList.add("is-invalid"),e===p&&(e.textContent=t,e.classList.remove("d-none")))}function S(e){return new Promise((t,n)=>{const a=new XMLHttpRequest;a.open("POST","/koordinator/check-email-exists",!0),a.setRequestHeader("Content-Type","application/json"),a.setRequestHeader("X-CSRF-TOKEN",document.querySelector('meta[name="csrf-token"]').getAttribute("content")),a.onload=function(){if(this.status===200)try{const i=JSON.parse(this.responseText);t(i.exists)}catch(i){console.error("Error parsing JSON:",i),t(!1)}else console.error("Error checking email:",this.status),t(!1)},a.onerror=function(){console.error("Network error when checking email"),t(!1)},a.send(JSON.stringify({email:e}))})}}
