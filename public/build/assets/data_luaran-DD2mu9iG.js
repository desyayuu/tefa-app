$(document).ready(function(){const u=$("#dokumentasi")[0].files;u&&u.length>0&&(l=Array.from(u)),$("#dokumentasiPreviewContainer").length&&!$("#dokumentasiPreviewItems").length&&$("#dokumentasiPreviewContainer").append('<div id="dokumentasiPreviewItems"></div>'),$(document).on("click",".poster-item, .poster-item img",function(t){t.preventDefault(),t.stopPropagation();let e;return $(this).hasClass("poster-item")?e=$(this).find("img").attr("src"):e=$(this).attr("src"),$("#posterPreviewImage").attr("src",e),$("#posterPreviewModal").modal("show"),!1});function c(t){$("#luaran-section").append('<div class="loading-overlay"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>'),$.ajax({url:`/koordinator/proyek/${t}/luaran`,type:"GET",dataType:"json",headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},success:function(e){e.success?k(e.data):(console.error("Error fetching data:",e.message),Swal.fire({icon:"error",title:"Gagal Memuat Data",text:e.message||"Terjadi kesalahan saat memuat data.",confirmButtonText:"OK"}))},error:function(e){console.error("AJAX error when fetching data:",e.responseText),Swal.fire({icon:"error",title:"Gagal Memuat Data",text:"Terjadi kesalahan saat memuat data.",confirmButtonText:"OK"})},complete:function(){$(".loading-overlay").remove()}})}function k(t){const e=t.luaran,i=t.dokumentasi;if($(".dokumentasi-gallery").empty(),$(".poster-item").remove(),$("#poster_proyek")[0].files,$("#dokumentasi")[0].files,$("#formLuaranProyek")[0].reset(),$("#posterPreview").empty(),e){if($('input[name="luaran_proyek_id"]').val(e.luaran_proyek_id),$("#link_proyek").val(e.link_proyek||""),$("#deskripsi_luaran").val(e.deskripsi_luaran||""),e.poster_proyek){const a=e.poster_proyek.split(".").pop().toLowerCase(),n=m(e.poster_proyek);if(["jpg","jpeg","png","gif"].includes(a)){const o=`
                        <div class="poster-item">
                            <img src="${n}?t=${new Date().getTime()}" class="img-fluid" alt="Poster Proyek">
                        </div>
                    `;$(".poster-item").remove(),$("#poster_proyek").before(o)}}}else console.log("No luaran data found");i&&i.length>0?i.forEach(function(a){const o=`
                    <div class="dokumentasi-item position-relative">
                        <img src="${m(a.path_file)}?t=${new Date().getTime()}" 
                            alt="${a.nama_file}"
                            class="img-fluid rounded">
                        <button type="button" 
                                class="btn btn-hapus-detail btn-delete-dokumentasi" 
                                data-id="${a.dokumentasi_proyek_id}">
                            <svg width="16" height="16" viewBox="0 0 19 19" fill="white" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M18.7851 9.48484C18.7851 14.6563 14.6051 18.8486 9.44866 18.8486C4.29227 18.8486 0.112183 14.6563 0.112183 9.48484C0.112183 4.31339 4.29227 0.121094 9.44866 0.121094C14.6051 0.121094 18.7851 4.31339 18.7851 9.48484ZM12.8922 4.61499L12.968 4.54584C13.3602 4.22524 13.9388 4.24842 14.3043 4.61499C14.6698 4.98156 14.6929 5.56186 14.3733 5.9552L14.3043 6.03127L10.8608 9.48484L14.3043 12.9384C14.6942 13.3295 14.6942 13.9636 14.3043 14.3546C13.9143 14.7457 13.2821 14.7457 12.8921 14.3546L9.44866 10.9011L6.00519 14.3546C5.61524 14.7457 4.98299 14.7457 4.59304 14.3546C4.20309 13.9636 4.20309 13.3295 4.59304 12.9384L8.03651 9.48484L4.59299 6.03127L4.52404 5.9552C4.20437 5.56186 4.22749 4.98157 4.59299 4.61499C4.9585 4.24842 5.5371 4.22524 5.9293 4.54584L6.00514 4.61499L9.44866 8.06857L12.8922 4.61499Z"/>
                            </svg>
                        </button>
                    </div>`;$(".dokumentasi-gallery").append(o)}):$(".dokumentasi-gallery").append('<div id="dokumentasiGalleryContainer" class="d-flex flex-wrap gap-3"></div>'),$(".dokumentasi-gallery img, .poster-item img").each(function(){const a=$(this).attr("src");a&&!a.includes("data:image")&&!a.includes("?t=")&&$(this).attr("src",a+"?t="+new Date().getTime())})}function m(t){return t?t.startsWith("http://")||t.startsWith("https://")||t.startsWith("/")?t:"/"+t:""}const p=$('input[name="proyek_id"]').val();p?c(p):console.warn("No proyek_id found on page load"),$(document).on("click","#btnRefreshData",function(){const t=$('input[name="proyek_id"]').val();t?c(t):(console.warn("Cannot refresh - No proyek_id found"),Swal.fire({icon:"warning",title:"Peringatan",text:"ID Proyek tidak ditemukan.",confirmButtonText:"OK"}))}),$("#btnUploadDokumentasi").off("click").on("click",function(){$("#dokumentasi").click()}),$(document).on("click",".btn-delete-dokumentasi",function(){const t=$(this).data("id"),e=$(this).closest(".dokumentasi-item");Swal.fire({title:"Hapus Dokumentasi",text:"Apakah Anda yakin ingin menghapus dokumentasi ini?",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Ya, Hapus",cancelButtonText:"Batal"}).then(i=>{i.isConfirmed?(e.css("opacity","0.5"),$.ajax({url:`/koordinator/proyek/dokumentasi/${t}`,type:"DELETE",headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},success:function(a){a.success?(e.fadeOut(300,function(){$(this).remove()}),Swal.fire({icon:"success",title:"Berhasil!",text:"Dokumentasi berhasil dihapus.",confirmButtonText:"OK"})):(e.css("opacity","1"),console.error("Delete error:",a.message),Swal.fire({icon:"error",title:"Gagal!",text:a.message||"Terjadi kesalahan saat menghapus dokumentasi.",confirmButtonText:"OK"}))},error:function(a){e.css("opacity","1"),console.error("Delete AJAX error:",a.responseText),Swal.fire({icon:"error",title:"Gagal!",text:"Terjadi kesalahan saat menghapus dokumentasi.",confirmButtonText:"OK"})}})):console.log("Delete confirmation: No")})}),$(document).on("click",".dokumentasi-gallery .dokumentasi-item img",function(t){const e=$(this).attr("src");$("#dokumentasiPreviewImage").attr("src",e),$("#dokumentasiPreviewModal").modal("show")}),$(document).on("click","#posterPreview img",function(t){t.preventDefault(),t.stopPropagation();const e=$(this).attr("src");return $("#posterPreviewImage").attr("src",e),$("#posterPreviewModal").modal("show"),!1}),$("#poster_proyek").on("change",function(){if(this.files.length>0){const t=this.files[0];if(t.type.match("image.*")){const i=new FileReader;i.onload=function(a){$("#posterPreviewContainer").show(),$("#posterPreview").html(`
                        <div class="poster-item position-relative">
                            <img src="${a.target.result}" class="img-fluid">
                            <button type="button" class="btn btn-hapus-detail btn-remove-poster">
                                <svg width="16" height="16" viewBox="0 0 19 19" fill="white" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M18.7851 9.48484C18.7851 14.6563 14.6051 18.8486 9.44866 18.8486C4.29227 18.8486 0.112183 14.6563 0.112183 9.48484C0.112183 4.31339 4.29227 0.121094 9.44866 0.121094C14.6051 0.121094 18.7851 4.31339 18.7851 9.48484ZM12.8922 4.61499L12.968 4.54584C13.3602 4.22524 13.9388 4.24842 14.3043 4.61499C14.6698 4.98156 14.6929 5.56186 14.3733 5.9552L14.3043 6.03127L10.8608 9.48484L14.3043 12.9384C14.6942 13.3295 14.6942 13.9636 14.3043 14.3546C13.9143 14.7457 13.2821 14.7457 12.8921 14.3546L9.44866 10.9011L6.00519 14.3546C5.61524 14.7457 4.98299 14.7457 4.59304 14.3546C4.20309 13.9636 4.20309 13.3295 4.59304 12.9384L8.03651 9.48484L4.59299 6.03127L4.52404 5.9552C4.20437 5.56186 4.22749 4.98157 4.59299 4.61499C4.9585 4.24842 5.5371 4.22524 5.9293 4.54584L6.00514 4.61499L9.44866 8.06857L12.8922 4.61499Z"/>
                                </svg>
                            </button>
                        </div>
                    `)},i.readAsDataURL(t)}else $("#posterPreview").empty(),$("#posterPreview").children().length===0&&$("#posterPreviewContainer").hide()}else $("#posterPreview").empty(),$("#posterPreviewContainer").hide()}),$(document).on("click",".btn-remove-poster",function(t){t.stopPropagation(),$("#posterPreview").empty(),$("#poster_proyek").val(""),$("#posterPreviewContainer").hide()}),$("#dokumentasi").off("change").on("change",function(){const t=this.files;if(t.length>0){$("#dokumentasiPreviewItems").length||($("#dokumentasiPreviewContainer").length?$("#dokumentasiPreviewContainer").append('<div id="dokumentasiPreviewItems"></div>'):$(".dokumentasi-gallery").after('<div id="dokumentasiPreviewContainer" class="dokumentasi-preview-container mt-3"><p class="dokumentasi-section-title">Preview Dokumentasi Baru</p><div id="dokumentasiPreviewItems"></div></div>')),$("#dokumentasiPreviewContainer").show();for(let e=0;e<t.length;e++){const i=t[e];if(!i.type.match("image.*")){console.warn("Skipping non-image file:",i.name);continue}const a=new FileReader;a.onload=function(n){const o=`
                        <div class="dokumentasi-item position-relative">
                            <img src="${n.target.result}" 
                                class="img-fluid rounded bg-light">
                            
                            <button type="button" class="btn btn-hapus-detail btn-remove-preview" data-filename="${i.name}">
                                <svg width="16" height="16" viewBox="0 0 19 19" fill="white" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M18.7851 9.48484C18.7851 14.6563 14.6051 18.8486 9.44866 18.8486C4.29227 18.8486 0.112183 14.6563 0.112183 9.48484C0.112183 4.31339 4.29227 0.121094 9.44866 0.121094C14.6051 0.121094 18.7851 4.31339 18.7851 9.48484ZM12.8922 4.61499L12.968 4.54584C13.3602 4.22524 13.9388 4.24842 14.3043 4.61499C14.6698 4.98156 14.6929 5.56186 14.3733 5.9552L14.3043 6.03127L10.8608 9.48484L14.3043 12.9384C14.6942 13.3295 14.6942 13.9636 14.3043 14.3546C13.9143 14.7457 13.2821 14.7457 12.8921 14.3546L9.44866 10.9011L6.00519 14.3546C5.61524 14.7457 4.98299 14.7457 4.59304 14.3546C4.20309 13.9636 4.20309 13.3295 4.59304 12.9384L8.03651 9.48484L4.59299 6.03127L4.52404 5.9552C4.20437 5.56186 4.22749 4.98157 4.59299 4.61499C4.9585 4.24842 5.5371 4.22524 5.9293 4.54584L6.00514 4.61499L9.44866 8.06857L12.8922 4.61499Z"/>
                                </svg>
                            </button>
                        </div>`;$("#dokumentasiPreviewItems").append(o)},a.onerror=function(){console.error("Error reading file:",i.name)},a.readAsDataURL(i)}}else $("#dokumentasiPreviewItems").children().length===0&&$("#dokumentasiPreviewContainer").hide()}),$("#btnSaveChanges").off("click").on("click",function(){const t=new FormData($("#formLuaranProyek")[0]);$(".is-invalid").removeClass("is-invalid"),$(".invalid-feedback").text("");const e=$(this),i=e.html();e.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Menyimpan...'),e.prop("disabled",!0);const a=$("#formLuaranProyek").data("luaranUrl");if($("#formLuaranProyek").data("dokumentasiUrl"),!a){console.error("Missing luaran URL data attribute"),s(!1,"URL untuk menyimpan data luaran tidak ditemukan.",e,i);return}$.ajax({url:a,type:"POST",data:t,processData:!1,contentType:!1,headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},success:function(n){n.success?(n.data&&n.data.id&&!$('input[name="luaran_proyek_id"]').val()&&$('input[name="luaran_proyek_id"]').val(n.data.id),$("#dokumentasi")[0].files.length>0?v(n.data.id,e,i):($("#dokumentasi").val(""),$("#poster_proyek").val(""),s(!0,"Data luaran proyek berhasil disimpan.",e,i))):(console.error("Save luaran error:",n.message),s(!1,n.message||"Terjadi kesalahan saat menyimpan data.",e,i))},error:function(n){if(console.error("Save luaran AJAX error:",n.responseText),n.status===422)try{const o=JSON.parse(n.responseText);o.errors?($.each(o.errors,function(r,d){const h=Array.isArray(d)?d[0]:d;$(`#${r}`).addClass("is-invalid"),$(`#${r}_error`).text(h)}),s(!1,"Mohon periksa kembali data yang diinput.",e,i)):s(!1,"Terjadi kesalahan validasi data.",e,i)}catch(o){console.error("Error parsing validation response:",o),s(!1,"Terjadi kesalahan saat validasi data.",e,i)}else s(!1,"Terjadi kesalahan saat menyimpan data.",e,i)}})});function v(t,e,i){const a=new FormData;a.append("luaran_proyek_id",t);const n=$("#dokumentasi")[0].files;for(let r=0;r<n.length;r++)a.append("dokumentasi[]",n[r]);const o=$("#formLuaranProyek").data("dokumentasiUrl");if(!o){console.error("Missing dokumentasi URL data attribute"),s(!1,"URL untuk mengunggah dokumentasi tidak ditemukan.",e,i);return}$.ajax({url:o,type:"POST",data:a,processData:!1,contentType:!1,headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},success:function(r){r.success?($("#dokumentasi").val(""),$("#poster_proyek").val(""),s(!0,"Data luaran dan dokumentasi proyek berhasil disimpan.",e,i)):(console.error("Upload dokumentasi error:",r.message),s(!1,"Data luaran berhasil disimpan, namun terjadi kesalahan saat mengunggah dokumentasi.",e,i))},error:function(r){console.error("Upload dokumentasi AJAX error:",r.responseText),s(!1,"Data luaran berhasil disimpan, namun terjadi kesalahan saat mengunggah dokumentasi.",e,i)}})}function s(t,e,i,a){i.html(a),i.prop("disabled",!1),t?($("#posterPreview").empty(),$("#posterPreviewContainer").hide(),$("#dokumentasiPreviewItems").empty(),$("#dokumentasiPreviewContainer").hide(),Swal.fire({icon:"success",title:"Berhasil",text:e,confirmButtonText:"OK"}).then(()=>{const n=$('input[name="proyek_id"]').val();n?c(n):window.location.reload()})):Swal.fire({icon:"error",title:"Gagal",text:e,confirmButtonText:"OK"})}let l=[];$("#btnUploadDokumentasi").off("click").on("click",function(){const t=document.createElement("input");t.type="file",t.multiple=!0,t.accept=".jpg,.jpeg,.png",t.addEventListener("change",function(){if(this.files.length>0){const a=Array.from(this.files);e(a),i(a),f()}}),t.click();function e(a){a.forEach(n=>{const o=l.findIndex(r=>r.name===n.name);o===-1?l.push(n):(l[o]=n,$(`.btn-remove-preview[data-filename="${n.name}"]`).closest(".dokumentasi-item").remove())})}function i(a){$("#dokumentasiPreviewItems").length||($("#dokumentasiPreviewContainer").length?$("#dokumentasiPreviewContainer").append('<div id="dokumentasiPreviewItems"></div>'):$(".dokumentasi-gallery").after('<div id="dokumentasiPreviewContainer" class="dokumentasi-preview-container mt-3"><p class="dokumentasi-section-title">Preview Dokumentasi Baru</p><div id="dokumentasiPreviewItems"></div></div>')),$("#dokumentasiPreviewContainer").show(),a.forEach(n=>{if(!n.type.match("image.*")){console.warn("Skipping non-image file:",n.name);return}const o=new FileReader;o.onload=function(r){const d=`
                    <div class="dokumentasi-item position-relative">
                        <img src="${r.target.result}" 
                            class="img-fluid rounded bg-light">
                        
                        <button type="button" class="btn btn-hapus-detail btn-remove-preview" data-filename="${n.name}">
                            <svg width="16" height="16" viewBox="0 0 19 19" fill="white" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M18.7851 9.48484C18.7851 14.6563 14.6051 18.8486 9.44866 18.8486C4.29227 18.8486 0.112183 14.6563 0.112183 9.48484C0.112183 4.31339 4.29227 0.121094 9.44866 0.121094C14.6051 0.121094 18.7851 4.31339 18.7851 9.48484ZM12.8922 4.61499L12.968 4.54584C13.3602 4.22524 13.9388 4.24842 14.3043 4.61499C14.6698 4.98156 14.6929 5.56186 14.3733 5.9552L14.3043 6.03127L10.8608 9.48484L14.3043 12.9384C14.6942 13.3295 14.6942 13.9636 14.3043 14.3546C13.9143 14.7457 13.2821 14.7457 12.8921 14.3546L9.44866 10.9011L6.00519 14.3546C5.61524 14.7457 4.98299 14.7457 4.59304 14.3546C4.20309 13.9636 4.20309 13.3295 4.59304 12.9384L8.03651 9.48484L4.59299 6.03127L4.52404 5.9552C4.20437 5.56186 4.22749 4.98157 4.59299 4.61499C4.9585 4.24842 5.5371 4.22524 5.9293 4.54584L6.00514 4.61499L9.44866 8.06857L12.8922 4.61499Z"/>
                            </svg>
                        </button>
                    </div>`;$("#dokumentasiPreviewItems").append(d)},o.onerror=function(){console.error("Error reading file:",n.name)},o.readAsDataURL(n)})}}),$(document).on("click",".btn-remove-preview",function(t){t.preventDefault(),t.stopPropagation();const e=$(this).data("filename"),i=l.findIndex(a=>a.name===e);i!==-1&&(l.splice(i,1),f()),$(this).closest(".dokumentasi-item").fadeOut(300,function(){$(this).remove(),$("#dokumentasiPreviewItems").children().length===0&&$("#dokumentasiPreviewContainer").hide()})});function f(){const t=new DataTransfer;l.forEach(e=>{t.items.add(e)}),$("#dokumentasi")[0].files=t.files}});
