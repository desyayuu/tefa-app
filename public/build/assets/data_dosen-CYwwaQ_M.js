document.addEventListener("DOMContentLoaded",function(){Z(),oe(),le(),de()});function Z(){document.querySelectorAll(".alert-dismissible").forEach(function(n){setTimeout(function(){new bootstrap.Alert(n).close()},3e3)})}function O(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}function ee(e){return/^\d{10}$/.test(e)}function te(e){return new Promise((n,i)=>{const a=new FormData;a.append("email_dosen",e),a.append("_token",document.querySelector('meta[name="csrf-token"]').getAttribute("content")),fetch("/koordinator/check-email-nidn-exists",{method:"POST",body:a}).then(t=>{if(!t.ok)throw new Error("Network response was not ok");return t.json()}).then(t=>{n(t.emailExists)}).catch(t=>{i(t)})})}function ne(e){return new Promise((n,i)=>{const a=new FormData;a.append("nidn_dosen",e),a.append("_token",document.querySelector('meta[name="csrf-token"]').getAttribute("content")),fetch("/koordinator/check-email-nidn-exists",{method:"POST",body:a}).then(t=>{if(!t.ok)throw new Error("Network response was not ok");return t.json()}).then(t=>{n(t.nidnExists)}).catch(t=>{i(t)})})}function ae(e){return e.querySelectorAll('input[type="date"]').forEach(i=>{if(i.value===""){const a=i.getAttribute("name");i.setAttribute("data-original-name",a),i.removeAttribute("name")}}),!0}function T(e){if(e.value.trim()){e.classList.remove("is-invalid");const n=e.nextElementSibling;return n&&n.classList.contains("invalid-feedback")&&(n.textContent=""),!0}else{e.classList.add("is-invalid");const n=e.nextElementSibling;if(n&&n.classList.contains("invalid-feedback"))n.textContent="Nama dosen wajib diisi";else{const i=document.createElement("div");i.classList.add("invalid-feedback"),i.textContent="Nama dosen wajib diisi",e.parentNode.appendChild(i)}return!1}}function _(e){const n=e.value.trim();if(!n){e.classList.add("is-invalid");const a=e.nextElementSibling;if(a&&a.classList.contains("invalid-feedback"))a.textContent="NIDN/NIP wajib diisi";else{const t=document.createElement("div");t.classList.add("invalid-feedback"),t.textContent="NIDN/NIP wajib diisi",e.parentNode.appendChild(t)}return!1}if(!/^\d{10}$/.test(n)){e.classList.add("is-invalid");const a=e.nextElementSibling;if(a&&a.classList.contains("invalid-feedback"))a.textContent="NIDN harus berupa angka dan tepat 10 digit";else{const t=document.createElement("div");t.classList.add("invalid-feedback"),t.textContent="NIDN harus berupa angka dan tepat 10 digit",e.parentNode.appendChild(t)}return!1}e.classList.remove("is-invalid");const i=e.nextElementSibling;return i&&i.classList.contains("invalid-feedback")&&(i.textContent=""),!0}function C(e){const n=e.value.trim();if(!n){e.classList.add("is-invalid");const a=e.nextElementSibling;if(a&&a.classList.contains("invalid-feedback"))a.textContent="Email wajib diisi";else{const t=document.createElement("div");t.classList.add("invalid-feedback"),t.textContent="Email wajib diisi",e.parentNode.appendChild(t)}return!1}if(!O(n)){e.classList.add("is-invalid");const a=e.nextElementSibling;if(a&&a.classList.contains("invalid-feedback"))a.textContent="Format email tidak valid";else{const t=document.createElement("div");t.classList.add("invalid-feedback"),t.textContent="Format email tidak valid",e.parentNode.appendChild(t)}return!1}e.classList.remove("is-invalid");const i=e.nextElementSibling;return i&&i.classList.contains("invalid-feedback")&&(i.textContent=""),!0}async function ie(e,n,i){const a=e.value.trim();if(a===i){e.classList.remove("is-invalid");const t=e.nextElementSibling;return t&&t.classList.contains("invalid-feedback")&&(t.textContent=""),!0}if(!_(e))return!1;try{const t=new FormData;t.append("nidn_dosen",a),t.append("dosen_id",n),t.append("_token",document.querySelector('meta[name="csrf-token"]').getAttribute("content")),e.classList.add("is-loading");const o=await fetch("/koordinator/check-email-nidn-exists",{method:"POST",body:t});if(e.classList.remove("is-loading"),!o.ok)throw new Error("Network response was not ok");if((await o.json()).nidnExists){e.classList.add("is-invalid");const l=e.nextElementSibling;if(l&&l.classList.contains("invalid-feedback"))l.textContent="NIDN sudah terdaftar dalam sistem.";else{const c=document.createElement("div");c.classList.add("invalid-feedback"),c.textContent="NIDN sudah terdaftar dalam sistem.",e.parentNode.appendChild(c)}return!1}else{e.classList.remove("is-invalid");const l=e.nextElementSibling;return l&&l.classList.contains("invalid-feedback")&&(l.textContent=""),!0}}catch(t){console.error("Error validating NIDN:",t),e.classList.remove("is-loading"),e.classList.add("is-invalid");const o=e.nextElementSibling;if(o&&o.classList.contains("invalid-feedback"))o.textContent="Gagal memeriksa NIDN. Silakan coba lagi.";else{const s=document.createElement("div");s.classList.add("invalid-feedback"),s.textContent="Gagal memeriksa NIDN. Silakan coba lagi.",e.parentNode.appendChild(s)}return!1}}async function se(e,n,i){const a=e.value.trim();if(a===i){e.classList.remove("is-invalid");const t=e.nextElementSibling;return t&&t.classList.contains("invalid-feedback")&&(t.textContent=""),!0}if(!C(e))return!1;try{const t=new FormData;t.append("email_dosen",a),t.append("dosen_id",n),t.append("_token",document.querySelector('meta[name="csrf-token"]').getAttribute("content")),e.classList.add("is-loading");const o=await fetch("/koordinator/check-email-nidn-exists",{method:"POST",body:t});if(e.classList.remove("is-loading"),!o.ok)throw new Error("Network response was not ok");if((await o.json()).emailExists){e.classList.add("is-invalid");const l=e.nextElementSibling;if(l&&l.classList.contains("invalid-feedback"))l.textContent="Email sudah terdaftar dalam sistem.";else{const c=document.createElement("div");c.classList.add("invalid-feedback"),c.textContent="Email sudah terdaftar dalam sistem.",e.parentNode.appendChild(c)}return!1}else{e.classList.remove("is-invalid");const l=e.nextElementSibling;return l&&l.classList.contains("invalid-feedback")&&(l.textContent=""),!0}}catch(t){console.error("Error validating email:",t),e.classList.remove("is-loading"),e.classList.add("is-invalid");const o=e.nextElementSibling;if(o&&o.classList.contains("invalid-feedback"))o.textContent="Gagal memeriksa email. Silakan coba lagi.";else{const s=document.createElement("div");s.classList.add("invalid-feedback"),s.textContent="Gagal memeriksa email. Silakan coba lagi.",e.parentNode.appendChild(s)}return!1}}function oe(){let e=[];const n=document.getElementById("btnTambahkanKeDaftarDosen"),i=document.getElementById("daftarDosen"),a=document.getElementById("dosenJsonData"),t=document.getElementById("isSingle"),o=document.getElementById("emptyRow"),s=document.getElementById("formTambahDosen"),l=document.getElementById("modalTambahDosen");document.getElementById("btnSimpan");const c=document.getElementById("form_error"),m=document.getElementById("nama_dosen"),f=document.getElementById("nidn_dosen"),y=document.getElementById("status_akun_dosen"),r=document.getElementById("email_dosen"),p=document.getElementById("password_dosen"),D=document.getElementById("tanggal_lahir_dosen"),w=document.getElementById("jenis_kelamin_dosen"),S=document.getElementById("telepon_dosen"),b=document.getElementById("profile_img_dosen"),L=document.getElementById("nama_error"),h=document.getElementById("nidn_error"),$=document.getElementById("status_akun_error"),E=document.getElementById("email_error"),q=document.getElementById("password_error"),M=document.getElementById("tanggal_lahir_error"),V=document.getElementById("jenis_kelamin_error"),j=document.getElementById("telepon_error"),k=document.getElementById("profile_img_error");K(),z(),l&&l.addEventListener("hidden.bs.modal",U),n&&n.addEventListener("click",Q),s&&s.addEventListener("submit",Y);function K(){const d=document.getElementById("togglePassword");d&&p&&d.addEventListener("click",function(){const u=p.getAttribute("type")==="password"?"text":"password";p.setAttribute("type",u);const v=document.getElementById("eye-icon");v&&(u==="text"?(v.classList.remove("bi-eye"),v.classList.add("bi-eye-slash")):(v.classList.remove("bi-eye-slash"),v.classList.add("bi-eye")))})}function z(){m&&m.addEventListener("blur",function(){T(m)}),f&&f.addEventListener("blur",function(){_(f)}),r&&r.addEventListener("blur",function(){C(r)})}function X(){const d=e.length,u={nama_dosen:m.value.trim(),nidn_dosen:f.value.trim(),status_akun_dosen:y.value,email_dosen:r.value.trim(),password_dosen:p.value||f.value.trim(),tanggal_lahir_dosen:D.value,jenis_kelamin_dosen:w.value||null,telepon_dosen:S.value.trim(),has_profile_img:b.files.length>0,profile_img_name:b.files.length>0?b.files[0].name:""};if(e.push(u),a.value=JSON.stringify(e),b.files.length>0){const v=document.createElement("input");v.type="file",v.name=`profile_img_dosen_${d}`,v.classList.add("d-none"),v.setAttribute("data-dosen-index",d);const g=new DataTransfer;g.items.add(b.files[0]),v.files=g.files,s.appendChild(v)}F()}function F(){o&&o.remove(),i.innerHTML="",e.forEach((d,u)=>{const v=document.createElement("tr"),g=d.has_profile_img?`<i class="bi bi-image text-success"></i> ${d.profile_img_name}`:"No image";v.innerHTML=`
                <td>${d.nama_dosen}</td>
                <td>${d.nidn_dosen}</td>
                <td>${d.email_dosen}</td>
                <td>${d.status_akun_dosen}</td>
                <td>${g}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger" data-index="${u}">Hapus</button>
                </td>
            `;const H=v.querySelector("button[data-index]");H&&H.addEventListener("click",function(){const N=parseInt(this.getAttribute("data-index")),R=s.querySelector(`input[name="profile_img_dosen_${N}"]`);R&&R.remove(),e.splice(N,1),a.value=JSON.stringify(e),s.querySelectorAll("input[data-dosen-index]").forEach(A=>{const B=parseInt(A.getAttribute("data-dosen-index"));B>N&&(A.name=`profile_img_dosen_${B-1}`,A.setAttribute("data-dosen-index",B-1))}),F(),e.length===0&&(i.innerHTML=`
                            <tr id="emptyRow">
                                <td colspan="6" class="text-center">Belum ada dosen yang ditambahkan ke daftar</td>
                            </tr>
                        `)}),i.appendChild(v)})}function P(){m&&(m.value=""),f&&(f.value=""),y&&(y.value="Active"),r&&(r.value=""),p&&(p.value=""),D&&(D.value=""),w&&(w.value=""),S&&(S.value=""),b&&(b.value=""),x()}function x(){c&&(c.classList.add("d-none"),c.textContent=""),s&&s.querySelectorAll(".is-invalid").forEach(u=>{u.classList.remove("is-invalid")}),L&&(L.textContent=""),h&&(h.textContent=""),$&&($.textContent=""),E&&(E.textContent=""),q&&(q.textContent=""),M&&(M.textContent=""),V&&(V.textContent=""),j&&(j.textContent=""),k&&(k.textContent="")}function U(){P(),x(),e=[],a&&(a.value="[]"),t&&(t.value="1"),s.querySelectorAll("input[data-dosen-index]").forEach(u=>u.remove()),i&&(i.innerHTML=`
                <tr id="emptyRow">
                    <td colspan="6" class="text-center">Belum ada dosen yang ditambahkan ke daftar</td>
                </tr>
            `)}async function W(){let d=!0;if(x(),m&&!m.value.trim()&&(m.classList.add("is-invalid"),L&&(L.textContent="Nama dosen wajib diisi"),d=!1),f&&!f.value.trim())f.classList.add("is-invalid"),h&&(h.textContent="NIDN/NIP wajib diisi"),d=!1;else if(f){const u=f.value.trim();if(!ee(u))f.classList.add("is-invalid"),h&&(h.textContent="NIDN harus berupa angka dan tepat 10 digit"),d=!1;else if(e.some(g=>g.nidn_dosen===u))f.classList.add("is-invalid"),h&&(h.textContent="NIDN/NIP sudah ada di daftar yang akan ditambahkan"),d=!1;else{f.classList.add("is-loading");try{const g=await ne(u);f.classList.remove("is-loading"),g&&(f.classList.add("is-invalid"),h&&(h.textContent="NIDN/NIP sudah terdaftar di database"),d=!1)}catch(g){console.error("Error checking NIDN:",g),f.classList.remove("is-loading"),c&&(c.textContent="Terjadi kesalahan saat memeriksa NIDN. Silakan coba lagi.",c.classList.remove("d-none")),d=!1}}}if(r&&!r.value.trim())r.classList.add("is-invalid"),E&&(E.textContent="Email wajib diisi"),d=!1;else if(r&&!O(r.value.trim()))r.classList.add("is-invalid"),E&&(E.textContent="Format email tidak valid"),d=!1;else if(r){const u=r.value.trim();if(e.some(g=>g.email_dosen===u))r.classList.add("is-invalid"),E&&(E.textContent="Email sudah ada di daftar yang akan ditambahkan"),d=!1;else{r.classList.add("is-loading");try{const g=await te(u);r.classList.remove("is-loading"),g&&(r.classList.add("is-invalid"),E&&(E.textContent="Email sudah terdaftar di database",E.style.display="block"),d=!1)}catch(g){console.error("Error checking email:",g),r.classList.remove("is-loading"),c&&(c.textContent="Terjadi kesalahan saat memeriksa email. Silakan coba lagi.",c.classList.remove("d-none")),d=!1}}}if(b&&b.files.length>0){const u=b.files[0],v=u.size/1024/1024;["image/jpeg","image/png","image/jpg","image/gif"].includes(u.type)?v>2&&(b.classList.add("is-invalid"),k&&(k.textContent="Ukuran file terlalu besar. Maksimal 2MB"),d=!1):(b.classList.add("is-invalid"),k&&(k.textContent="Format file tidak valid. Gunakan jpeg, png, jpg, atau gif"),d=!1)}return d}async function Q(){x(),n.disabled=!0,n.innerHTML='<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Memeriksa...';try{const d=await W();if(n.disabled=!1,n.innerHTML="Tambahkan ke Daftar",!d)return;X(),P(),t&&(t.value="0")}catch(d){console.error("Validation error:",d),n.disabled=!1,n.innerHTML="Tambahkan ke Daftar",c&&(c.textContent="Terjadi kesalahan saat validasi. Silakan coba lagi.",c.classList.remove("d-none"))}}async function Y(d){if(d.preventDefault(),e.length>0||t.value==="1"){const u=s.querySelector('button[type="submit"]');u&&(u.disabled=!0,u.innerHTML='<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Menyimpan...'),s.submit()}else c&&(c.textContent="Belum ada dosen yang ditambahkan ke daftar.",c.classList.remove("d-none"))}}function le(){document.querySelectorAll('form[id^="form_edit_"]').forEach(n=>{const i=n.id.replace("form_edit_",""),a=document.getElementById(`edit_form_error_${i}`),t=document.getElementById(`modalDosen${i}`);t&&(t.addEventListener("show.bs.modal",function(){console.log(`Modal ${t.id} fully shown`),n.querySelectorAll('input:not([type="file"]), select, textarea').forEach(m=>{m.setAttribute("data-original-value",m.value)})}),t.addEventListener("show.bs.modal",function(){console.log(`Modal ${t.id} opening`),J(n)}));const o=document.getElementById(`nama_dosen_${i}`),s=document.getElementById(`nidn_dosen_${i}`),l=document.getElementById(`email_dosen_${i}`);o&&o.addEventListener("blur",function(){T(o)}),s&&s.addEventListener("blur",function(){_(s)}),l&&l.addEventListener("blur",function(){C(l)}),n.addEventListener("submit",async function(c){c.preventDefault(),a&&(a.classList.add("d-none"),a.textContent=""),G(n);const m=n.querySelector('button[type="submit"]');m&&(m.disabled=!0,m.innerHTML='<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Menyimpan...');let f=!0;if(o){const r=T(o);f=f&&r}if(s&&s.value!==s.getAttribute("data-original-value")){let r=_(s);r&&(r=await ie(s,i,s.getAttribute("data-original-value"))),f=f&&r}if(l&&l.value!==l.getAttribute("data-original-value")){let r=C(l);r&&(r=await se(l,i,l.getAttribute("data-original-value"))),f=f&&r}if(!f){m&&(m.disabled=!1,m.innerHTML="Simpan Perubahan"),a&&(a.textContent="Mohon periksa kembali data yang dimasukkan.",a.classList.remove("d-none"));const r=n.querySelector(".is-invalid");r&&(r.scrollIntoView({behavior:"smooth",block:"center"}),r.focus());return}ae(n);const y=new FormData(n);try{const r=await fetch(n.action,{method:"POST",body:y,headers:{"X-Requested-With":"XMLHttpRequest"}}),p=await r.json();r.ok?window.location.reload():(p.errors?re(n,p.errors,i):a&&(a.textContent=p.message||"Terjadi kesalahan saat menyimpan data.",a.classList.remove("d-none")),m&&(m.disabled=!1,m.innerHTML="Simpan Perubahan"))}catch(r){console.error("Error submitting form:",r),a&&(a.textContent="Terjadi kesalahan saat menyimpan data. Silakan coba lagi.",a.classList.remove("d-none")),m&&(m.disabled=!1,m.innerHTML="Simpan Perubahan")}})})}function G(e){e.querySelectorAll(".is-invalid").forEach(i=>{i.classList.remove("is-invalid");const a=i.nextElementSibling;a&&a.classList.contains("invalid-feedback")&&(a.textContent="")})}function re(e,n,i){for(const o in n){const s=`${o}_${i}`,l=document.getElementById(s);if(l){l.classList.add("is-invalid");const c=l.nextElementSibling;if(c&&c.classList.contains("invalid-feedback"))c.textContent=Array.isArray(n[o])?n[o][0]:n[o];else{const m=document.createElement("div");m.classList.add("invalid-feedback"),m.textContent=Array.isArray(n[o])?n[o][0]:n[o],l.parentNode.appendChild(m)}}}const a=document.getElementById(`edit_form_error_${i}`);a&&(a.textContent="Terdapat kesalahan pada form. Mohon periksa kembali data yang dimasukkan.",a.classList.remove("d-none"));const t=e.querySelector(".is-invalid");t&&(t.scrollIntoView({behavior:"smooth",block:"center"}),t.focus())}function de(){document.querySelectorAll('.modal[id^="modalDosen"]').forEach(n=>{n.id.replace("modalDosen","");const i=n.querySelector("form");n.addEventListener("show.bs.modal",function(){console.log(`Modal ${n.id} opened - storing original values`),J(i)});const a=n.querySelector("button.btn-tutup");a&&a.addEventListener("click",function(){console.log(`Cancel button clicked in modal ${n.id}`),I(i)});const t=n.querySelector("button.btn-close");t&&t.addEventListener("click",function(){console.log(`Close button clicked in modal ${n.id}`),I(i)}),n.addEventListener("hidden.bs.modal",function(){console.log(`Modal ${n.id} hidden`),I(i)})})}function J(e){e._originalValues={},e.querySelectorAll('input:not([type="file"]), select, textarea').forEach(i=>{const a=i.id;e._originalValues[a]=i.value,i.setAttribute("data-original-value",i.value),console.log(`Stored original value for ${a}: ${i.value}`)})}function I(e){console.log("Resetting form to original values"),e._originalValues?e.querySelectorAll('input:not([type="file"]), select, textarea').forEach(o=>{const s=o.id;if(e._originalValues[s]!==void 0)o.value=e._originalValues[s],console.log(`Reset ${s} to ${e._originalValues[s]}`);else{const l=o.getAttribute("data-original-value");l!=null&&(o.value=l,console.log(`Reset ${s} to ${l} (from attribute)`))}}):e.querySelectorAll('input:not([type="file"]), select, textarea').forEach(o=>{const s=o.getAttribute("data-original-value");s!=null&&(o.value=s,console.log(`Reset ${o.id} to ${s} (from attribute)`))}),e.querySelectorAll('input[type="file"]').forEach(t=>{t.value=""}),e.querySelectorAll('input[type="password"]').forEach(t=>{t.value=""}),G(e);const a=e.querySelector(".alert-danger");a&&(a.classList.add("d-none"),a.textContent="")}
