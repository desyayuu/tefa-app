import{s as c}from"./components-C-5l6dZl.js";function M(){let e=!0;$(".is-invalid").removeClass("is-invalid"),$(".invalid-feedback").text(""),$("#form_keuangan_tefa_error").addClass("d-none").text("");const a=[{id:"tanggal_transaksi",name:"Tanggal Transaksi"},{id:"jenis_transaksi_id",name:"Jenis Transaksi"},{id:"jenis_keuangan_tefa_id",name:"Keperluan Transaksi"},{id:"nama_transaksi",name:"Nama Transaksi"},{id:"nominal",name:"Nominal"}];if($.each(a,function(n,o){$("#"+o.id).val()||($("#"+o.id).addClass("is-invalid"),$("#"+o.id+"_error").text(`${o.name} wajib diisi`),e=!1)}),$("#jenis_keuangan_tefa_id option:selected").text()==="Proyek"&&!$("#proyek_id_selected").val()&&($("#proyek_id_selected").addClass("is-invalid"),$("#proyek_id_selected_error").text("Pilih proyek terlebih dahulu"),e=!1),$("#kategoriTransaksiContainer").is(":visible")&&$("#sub_jenis_transaksi_id").prop("required")&&!$("#sub_jenis_transaksi_id").val()){$("#sub_jenis_transaksi_id").addClass("is-invalid");const o=$("#jenis_transaksi_id option:selected").text()==="Pengeluaran"?"kategori pengeluaran":"kategori pemasukan";$("#sub_jenis_transaksi_id_error").text(`Pilih ${o}`),e=!1}const i=$("#nama_transaksi").val();i&&!Z(i)&&($("#nama_transaksi").addClass("is-invalid"),$("#nama_transaksi_error").text("Nama transaksi harus berisi 1-255 karakter"),e=!1);const s=$("#nominal").val();if(s){const n=parseInt(s.replace(/\D/g,""),10);(isNaN(n)||n<=0||n>=10**13)&&($("#nominal").addClass("is-invalid"),$("#nominal_error").text("Nominal harus berupa angka positif dan tidak melebihi batas maksimum"),e=!1)}return $("#file_keuangan_tefa")[0].files&&$("#file_keuangan_tefa")[0].files.length>0&&(T()||(e=!1)),e}function W(){let e=!0;$(".is-invalid").removeClass("is-invalid"),$(".invalid-feedback").text(""),$("#form_keuangan_tefa_edit_error").addClass("d-none").text("");const a=[{id:"edit_jenis_transaksi_id",name:"Jenis Transaksi"},{id:"edit_tanggal_transaksi",name:"Tanggal Transaksi"},{id:"edit_jenis_keuangan_tefa_id",name:"Keperluan Transaksi"},{id:"edit_nama_transaksi",name:"Nama Transaksi"},{id:"edit_nominal",name:"Nominal"}];$.each(a,function(o,r){$("#"+r.id).val()||($("#"+r.id).addClass("is-invalid"),$("#"+r.id+"_error").text(`${r.name} wajib diisi`),e=!1)});const t=$("#edit_nama_transaksi").val();t&&(t.trim().length===0||t.trim().length>255)&&($("#edit_nama_transaksi").addClass("is-invalid"),$("#edit_nama_transaksi_error").text("Nama transaksi harus berisi 1-255 karakter"),e=!1);const i=$("#edit_nominal").val();if(i){const o=parseInt(i.replace(/\D/g,""),10);(isNaN(o)||o<=0||o>=10**13)&&($("#edit_nominal").addClass("is-invalid"),$("#edit_nominal_error").text("Nominal harus berupa angka positif dan tidak melebihi batas maksimum"),e=!1)}$("#edit_jenis_keuangan_tefa_id option:selected").text()==="Proyek"&&!$("#edit_proyek_id_selected").val()&&($("#edit_proyek_id_selected").addClass("is-invalid"),$("#edit_proyek_id_selected_error").text("Pilih proyek terlebih dahulu"),e=!1);const n=$("#edit_jenis_transaksi_id option:selected").text();if($("#edit_kategoriTransaksiContainer").is(":visible")&&$("#edit_sub_jenis_transaksi_id").prop("required")&&!$("#edit_sub_jenis_transaksi_id").val()){$("#edit_sub_jenis_transaksi_id").addClass("is-invalid");const r=n==="Pengeluaran"?"kategori pengeluaran":"kategori pemasukan";$("#edit_sub_jenis_transaksi_id_error").text(`Pilih ${r}`),e=!1}return $("#edit_file_keuangan_tefa")[0].files&&$("#edit_file_keuangan_tefa")[0].files.length>0&&(w()||(e=!1)),e||$("#form_keuangan_tefa_edit_error").removeClass("d-none").text("Silakan periksa kembali formulir Anda."),e}function Z(e){return e.trim().length>0&&e.trim().length<=255}function P(){const e=$("#isSingleKeuanganTefa").val()==="1";console.log("Submit form with mode:",e?"Single":"Multiple");const a=$("#keuangan_tefa_JsonData").val();console.log("keuangan_tefa_JsonData before submission:",a);const t=document.getElementById("file_keuangan_tefa");if(t.files&&t.files.length>0?console.log("File attached in form:",t.files[0].name):console.log("No file attached in main form"),!e&&window.keuanganTefaFiles&&console.log("Stored files:",Object.keys(window.keuanganTefaFiles).length),e){const i=new FormData($("#formTambahDataKeuanganTefa")[0]);return $("#btnSimpanKeuanganTefa").prop("disabled",!0).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Menyimpan...'),$.ajax({url:"/koordinator/keuangan-tefa/store",type:"POST",data:i,processData:!1,contentType:!1,success:function(s){K()},error:function(s,n,o){S(s)}}),_(),!0}else{const i=JSON.parse($("#keuangan_tefa_JsonData").val());if(console.log("itemList for multiple mode:",i),i.length===0)return $("#form_keuangan_tefa_error").removeClass("d-none").addClass("alert-danger").text("Tambahkan minimal satu item ke daftar sebelum menyimpan."),!1;const s=new FormData($("#formTambahDataKeuanganTefa")[0]);if(s.set("keuangan_tefa_data",JSON.stringify(i)),s.set("is_single","0"),window.keuanganTefaFiles){let n=0;for(const[o,r]of Object.entries(window.keuanganTefaFiles))r instanceof File&&(s.append(`file_keuangan_tefa_${o}`,r),n++,console.log(`Added file for item ${o}: ${r.name}`));console.log(`Total ${n} files added to request`)}$("#btnSimpanKeuanganTefa").prop("disabled",!0).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Menyimpan...'),console.log("Form data keys:");for(let n of s.keys())console.log(n);return $.ajax({url:"/koordinator/keuangan-tefa/store-with-files",type:"POST",data:s,processData:!1,contentType:!1,success:function(n){K()},error:function(n,o,r){S(n)}}),_(),!0}}function Y(){const e=new FormData($("#formEditDataKeuanganTefa")[0]),a=$("#keuangan_tefa_id").val();$("#btnSimpanEditKeuanganTefa").prop("disabled",!0).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Menyimpan...'),$.ajax({url:`/koordinator/keuangan-tefa/update/${a}`,type:"POST",data:e,processData:!1,contentType:!1,success:function(t){t.success?c.successMessage(t.message).then(i=>{i.isConfirmed&&($("#modalEditKeuanganTefa").modal("hide"),f())}):c.errorMessage(t.message),$("#btnSimpanEditKeuanganTefa").prop("disabled",!1).text("Simpan Data"),_()},error:function(t,i,s){console.error("AJAX error:",t.status,t.statusText);try{const n=JSON.parse(t.responseText);if(t.status===422&&n.errors){let o="Validation errors:<br>";Object.keys(n.errors).forEach(r=>{const l=r.replace("edit_","");o+=`- ${l}: ${n.errors[r]}<br>`}),$("#form_keuangan_tefa_edit_error").removeClass("d-none").html(o)}else c.errorMessage("An error occurred while saving data.",n.message||s)}catch(n){c.errorMessage("An unexpected error occurred. Please try again later.",n)}$("#btnSimpanEditKeuanganTefa").prop("disabled",!1).text("Simpan Data")}})}function K(e){console.log("=== SUBMIT SUCCESS ==="),V(),f(),_(),c.successMessage("Data keuangan TEFA berhasil disimpan.").then(a=>{a.isConfirmed&&(console.log("User clicked OK - closing modal"),$("#modalTambahKeuanganTefa").modal("hide"))}),console.log("Submit success completed - waiting for user to click OK")}function S(e,a,t,i){var s;if($("#btnSimpanKeuanganTefa").prop("disabled",!1).html("Simpan Data"),e.status===422){const n=e.responseJSON.errors;$(".is-invalid").removeClass("is-invalid");for(const o in n){const r=n[o][0];$(`#${o}`).addClass("is-invalid"),$(`#${o}_error`).text(r)}$("#form_keuangan_tefa_error").removeClass("d-none").addClass("alert-danger").text("Terdapat kesalahan pada form. Silakan periksa kembali.")}else Swal.fire({icon:"error",title:"Error!",text:((s=e.responseJSON)==null?void 0:s.message)||"Terjadi kesalahan saat menyimpan data.",confirmButtonColor:"#dc3545"})}function E(e){$(e).off("input"),$(e).on("input",function(){const a=this.selectionStart,t=this.value.length;let i=$(this).val().replace(/\D/g,"");if(i===""){$(this).val("");return}i=i.replace(/^0+/,"")||"0",i=i.replace(/\B(?=(\d{3})+(?!\d))/g,"."),$(this).val(i);const s=i.length,n=a+(s-t);setTimeout(()=>{const o=Math.max(0,Math.min(n,s));this.setSelectionRange(o,o)},0),console.log("Formatted nominal:",i)}),$(e).on("paste",function(a){let t=a.originalEvent.clipboardData.getData("text");t=t.replace(/\D/g,""),a.preventDefault(),document.execCommand("insertText",!1,t)}),$(e).on("keydown",function(a){$.inArray(a.keyCode,[46,8,9,27,13])!==-1||a.keyCode===65&&a.ctrlKey===!0||a.keyCode===67&&a.ctrlKey===!0||a.keyCode===86&&a.ctrlKey===!0||a.keyCode===88&&a.ctrlKey===!0||a.keyCode>=35&&a.keyCode<=40||(a.shiftKey||a.keyCode<48||a.keyCode>57)&&(a.keyCode<96||a.keyCode>105)&&a.preventDefault()})}function j(e,a=3){if(!e)return"";const t=e.trim().split(/\s+/);if(t.length<=a)return e;const i=t.slice(0,a).join(" ")+"...";return`<span title="${e}">${i}</span>`}function Q(e){let a=String(e).replace(/\D/g,"");return a?a.replace(/\B(?=(\d{3})+(?!\d))/g,"."):"0"}function ee(e){let a=e.val().replace(/\D/g,"");if(a===""){e.val("");return}a=a.replace(/^0+/,"")||"0",a=a.replace(/\B(?=(\d{3})+(?!\d))/g,"."),e.val(a)}function T(){const e=document.getElementById("file_keuangan_tefa");if($(e).removeClass("is-invalid"),$("#file_keuangan_tefa_error").text(""),!e.files||e.files.length===0)return console.log("No file selected"),!0;const a=e.files[0];console.log("File details:",{name:a.name,size:a.size,type:a.type});const t=10*1024*1024;if(a.size>t)return console.error("File too large:",a.size),$(e).addClass("is-invalid"),$("#file_keuangan_tefa_error").text("Ukuran file maksimal 10MB"),!1;const s=a.name.toLowerCase().split(".").pop(),n=["pdf","doc","docx","xls","xlsx","ppt","pptx","jpg","jpeg","png"];return console.log("File validation:",{extension:s,isAllowedExtension:n.includes(s)}),n.includes(s)?!0:($(e).addClass("is-invalid"),$("#file_keuangan_tefa_error").text("Format file tidak didukung. Format yang diizinkan: PDF, DOC, DOCX, XLS, XLSX, PPT, PPTX, JPG, JPEG, PNG"),!1)}function w(){const e=document.getElementById("edit_file_keuangan_tefa");if($(e).removeClass("is-invalid"),$("#edit_file_keuangan_tefa_error").text(""),!e.files||e.files.length===0)return!0;const a=e.files[0],t=10*1024*1024;if(a.size>t)return $(e).addClass("is-invalid"),$("#edit_file_keuangan_tefa_error").text("Ukuran file maksimal 10MB"),!1;const s=a.name.toLowerCase().split(".").pop();return["pdf","doc","docx","xls","xlsx","ppt","pptx","jpg","jpeg","png"].includes(s)?!0:($(e).addClass("is-invalid"),$("#edit_file_keuangan_tefa_error").text("Format file tidak didukung. Format yang diizinkan: PDF, DOC, DOCX, XLS, XLSX, PPT, PPTX, JPG, JPEG, PNG"),!1)}function ae(){const e=document.getElementById("file_keuangan_tefa"),a=document.getElementById("file_preview_container")||$('<div id="file_preview_container" class="mt-2"></div>').insertAfter(e).get(0);if($(a).empty(),!e.files||e.files.length===0){console.log("No file selected for preview");return}const t=e.files[0];console.log("Preview file:",t.name,t.type,t.size);const i=t.name.toLowerCase().split(".").pop(),s=R(t.size),n=`
        <div class="file-preview-card border rounded p-3 mt-2 bg-light">
            <div class="d-flex align-items-center">
                <div class="file-icon me-3">
                    ${ne(i)}
                </div>
                <div class="file-details flex-grow-1">
                    <h6 class="mb-1 text-truncate" title="${t.name}">${t.name}</h6>
                    <small class="text-muted">${s} • ${i.toUpperCase()}</small>
                </div>
                <div class="file-actions">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearFilePreview()">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            </div>
            <div id="file-preview-content" class="mt-3"></div>
        </div>
    `;if($(a).html(n),["jpg","jpeg","png"].includes(i)){const o=new FileReader;o.onload=function(r){const l=`
                <div class="image-preview text-center">
                    <img src="${r.target.result}" class="img-thumbnail" style="max-height: 200px; max-width: 100%;" alt="Preview">
                </div>
            `;$("#file-preview-content").html(l)},o.readAsDataURL(t)}else $("#file-preview-content").html(`
            <div class="file-info-preview text-center text-muted">
                <i class="bi bi-file-earmark fs-1"></i>
                <p class="mb-0 small">Preview tidak tersedia untuk tipe file ini</p>
            </div>
        `)}function O(){const e=document.getElementById("edit_file_keuangan_tefa"),a=document.getElementById("edit_file_preview_container")||$('<div id="edit_file_preview_container" class="mt-2"></div>').insertAfter(e).get(0);if(!e.files||e.files.length===0)return;const t=e.files[0],i=t.name.toLowerCase().split(".").pop(),s=R(t.size),n=`
        <div class="mt-2 p-2 border rounded">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <div class="file-preview-card border rounded p-2 bg-white">
                        <div class="d-flex align-items-center">
                            <div class="file-details flex-grow-1">
                                <p class="mb-1 fw-bold text-truncate" title="${t.name}">${t.name}</p>
                                <small class="text-muted">${s} • ${i.toUpperCase()}</small>
                            </div>
                        </div>
                        <div id="edit-file-preview-content" class="mt-2"></div>
                    </div>
                </div>
            </div>
        </div>
    `;if($(a).html(n),["jpg","jpeg","png"].includes(i)){const o=new FileReader;o.onload=function(r){const l=`
                <div class="image-preview text-center">
                    <img src="${r.target.result}" class="img-thumbnail" style="max-height: 150px; max-width: 100%;" alt="Preview">
                </div>
            `;$("#edit-file-preview-content").html(l)},o.readAsDataURL(t)}}function te(e,a){a.toLowerCase().split(".").pop();const t=`
        <div class="mt-2 p-2 border rounded">
            <div class="d-flex align-items-center">
                    <div>
                        <small class="text-muted">File saat ini:</small><br>
                        <a href="${e}" target="_blank">
                            ${a}</a>
                    </div>
            </div>
            <small class="text-muted">Pilih file baru jika ingin mengganti</small>
        </div>
    `,i=$('<div id="edit_file_preview_container" class="mt-2"></div>').insertAfter("#edit_file_keuangan_tefa").get(0);$(i).html(t)}function ne(e){const a=ie(e);return`<i class="${a.icon} fs-1" style="color: ${a.color};"></i>`}function ie(e){switch(e){case"pdf":return{icon:"bi bi-file-earmark-pdf",color:"#dc3545"};case"doc":case"docx":return{icon:"bi bi-file-earmark-word",color:"#2b579a"};case"xls":case"xlsx":return{icon:"bi bi-file-earmark-excel",color:"#217346"};case"ppt":case"pptx":return{icon:"bi bi-file-earmark-ppt",color:"#d24726"};case"jpg":case"jpeg":case"png":return{icon:"bi bi-file-earmark-image",color:"#6f42c1"};default:return{icon:"bi bi-file-earmark",color:"#6c757d"}}}function R(e){if(e===0)return"0 Bytes";const a=1024,t=["Bytes","KB","MB","GB"],i=Math.floor(Math.log(e)/Math.log(a));return parseFloat((e/Math.pow(a,i)).toFixed(2))+" "+t[i]}$(document).ready(function(){$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}}),f(1,{}),de(),ue(),ce(),_(),$(document).on("click",".keuangan-pagination-link",function(e){e.preventDefault();const a=$(this).data("page");f(a)}),$("#modalTambahKeuanganTefa, #modalEditKeuanganTefa").on("shown.bs.modal",function(){A()}),$("#file_keuangan_tefa").prop("required",!1),$("#file_keuangan_tefa").change(function(){T()&&ae()}),$("#edit_file_keuangan_tefa").change(function(){w()&&O()}),$("#formTambahDataKeuanganTefa").submit(function(e){e.preventDefault();const a=$("#isSingleKeuanganTefa").val()==="1";if(a&&$("#file_keuangan_tefa")[0].files.length>0&&!T()){$("#form_keuangan_tefa_error").removeClass("d-none").text("Terdapat kesalahan pada file. Silakan periksa kembali.");return}if(!a&&JSON.parse($("#keuangan_tefa_JsonData").val()).length>0){P();return}M()&&P()}),$(document).on("change","#jenis_transaksi_id",function(){console.log("Form tambah - jenis_transaksi_id changed:",$(this).val()),F(),L()}),$(document).on("change","#jenis_keuangan_tefa_id",function(){console.log("Form tambah - jenis_keuangan_tefa_id changed:",$(this).val()),F(),L(),$(this).find("option:selected").text()==="Proyek"&&fe()}),$(document).on("change","#edit_jenis_transaksi_id",function(){console.log("Form edit - edit_jenis_transaksi_id changed:",$(this).val()),I(),N()}),$(document).on("change","#edit_jenis_keuangan_tefa_id",function(){console.log("Form edit - edit_jenis_keuangan_tefa_id changed:",$(this).val()),I(),N(),$(this).find("option:selected").text()==="Proyek"&&G()}),$("#btnTambahkanKeDaftarKeuanganTefa").off("click").on("click",function(){const e=$(this).text();$(this).prop("disabled",!0).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Menambahkan...');const a=pe();$(this).prop("disabled",!1).text(e),a||setTimeout(function(){$(".is-invalid:first").focus()},100)}),$(document).on("click",".btn-remove-item",function(){const e=$(this).data("id");removeFromList(e)}),$(document).on("click",".btn-action-detail-keuangan",function(){const e=$(this).data("id");me(e)}),$("#formEditDataKeuanganTefa").submit(function(e){e.preventDefault(),W()&&Y()}),$("#modalTambahKeuanganTefa").on("shown.bs.modal",function(){if(console.log("Modal tambah keuangan tefa opened"),!$("#tanggal_transaksi").val()){const e=new Date().toISOString().split("T")[0];$("#tanggal_transaksi").val(e),console.log("Set initial date to today:",e)}A(),re()}),$("#formTambahDataKeuanganTefa input, #formTambahDataKeuanganTefa select, #formTambahDataKeuanganTefa textarea").on("input change",function(){$(this).removeClass("is-invalid");const e=$(this).attr("id")+"_error";$("#"+e).text("")}),$("#proyek_id_selected, #sub_jenis_transaksi_id").on("select2:select",function(){$(this).removeClass("is-invalid");const e=$(this).attr("id")+"_error";$("#"+e).text("")}),$(document).off("click",".btn-remove-item").on("click",".btn-remove-item",function(){const e=$(this).data("id");console.log("Remove button clicked for item ID:",e),console.log("Item ID type:",typeof e),removeFromList(e)}),$("#edit_nominal").on("input",function(){let e=$(this).val().replace(/\D/g,"");if(e===""){$(this).val("");return}e=e.replace(/^0+/,"")||"0",e=e.replace(/\B(?=(\d{3})+(?!\d))/g,"."),$(this).val(e)}),le(),$("#btnToggleFilter").click(function(){$("#filterContainer").toggleClass("filter-collapsed"),localStorage.setItem("keuanganTefaFilterVisible",!$("#filterContainer").hasClass("filter-collapsed"))}),$("#btnResetFilter").click(function(){D()}),$("#formFilterKeuanganTefa").submit(function(e){e.preventDefault(),q()}),$("#filter_nominal_min, #filter_nominal_max").on("input",function(){ee($(this))}),localStorage.getItem("keuanganTefaFilterVisible")==="false"&&$("#filterContainer").addClass("filter-collapsed"),ke(),$("#modalTambahKeuanganTefa").on("hidden.bs.modal",function(){console.log("Modal tambah keuangan tefa closed - resetting form"),V(),$.fn.select2&&$("#proyek_id_selected, #sub_jenis_transaksi_id").each(function(){$(this).data("select2")&&$(this).select2("destroy")})}),$("#modalEditKeuanganTefa").on("hidden.bs.modal",function(){$.fn.select2&&$("#edit_proyek_id_selected, #edit_sub_jenis_transaksi_id").each(function(){$(this).data("select2")&&$(this).select2("destroy")})}),$(document).on("click",".keuangan-pagination-link",function(e){e.preventDefault();const a=$(this).data("page"),t=$(this).data("filters")||{};f(a,t)}),$(document).on("change","#filter_jenis_keuangan",function(){console.log("Filter - jenis_keuangan changed to:",$(this).val()),x(),m()}),$(document).on("change","#filter_jenis_transaksi",function(){console.log("Filter - jenis_transaksi changed to:",$(this).val()),m()}),J(),$("#btnResetFilter").off("click").on("click",function(){D(),setTimeout(J,100)}),$(document).on("click",".btn-action-delete",function(){const e=$(this).data("id");he(e)}),console.log("Container kategoriTransaksiContainer exists:",$("#kategoriTransaksiContainer").length),console.log("Container edit_kategoriTransaksiContainer exists:",$("#edit_kategoriTransaksiContainer").length),console.log("Container filterKategoriTransaksiContainer exists:",$("#filterKategoriTransaksiContainer").length),window.testFilterKategori=function(){console.log("=== TESTING FILTER KATEGORI ==="),console.log("Container exists:",$("#filterKategoriTransaksiContainer").length),console.log("Current visibility:",$("#filterKategoriTransaksiContainer").is(":visible")),$("#filterKategoriTransaksiContainer").show(),$("label[for='filter_sub_jenis_transaksi']").text("Test Kategori Filter"),console.log("After manual show:",$("#filterKategoriTransaksiContainer").is(":visible")),console.log("=== END TEST ===")},console.log("Run 'testFilterKategori()' in console to test filter")});function se(){const e=$("#filter_jenis_transaksi").val();e==="Pengeluaran"?$("label[for='filter_sub_jenis_transaksi']").text("Kategori Pengeluaran"):e==="Pemasukan"?$("label[for='filter_sub_jenis_transaksi']").text("Kategori Pemasukan"):$("label[for='filter_sub_jenis_transaksi']").text("Kategori Transaksi")}function q(){const e=$("#filter_tanggal_mulai").val(),a=$("#filter_tanggal_akhir").val();if(e&&a){const i=new Date(e);if(new Date(a)<i){c.errorMessage("Tanggal Akhir tidak boleh lebih awal dari Tanggal Mulai");return}}const t={tanggal_mulai:e,tanggal_akhir:a,jenis_transaksi:$("#filter_jenis_transaksi").val(),jenis_keuangan:$("#filter_jenis_keuangan").val(),nama_transaksi:$("#filter_nama_transaksi").val(),proyek_id:$("#filter_proyek").val(),sub_jenis_transaksi_id:$("#filter_sub_jenis_transaksi").val()};console.log("Applied filters:",t),oe(),f(1,t)}function oe(){$("#formFilterKeuanganTefa").find("input, select").each(function(){$(this).attr("id")&&localStorage.setItem($(this).attr("id"),$(this).val())}),localStorage.setItem("keuanganTefaFiltersApplied",new Date().getTime())}function D(){console.log("Starting comprehensive filter reset..."),$("#formFilterKeuanganTefa")[0].reset(),console.log("Resetting proyek container..."),$("#filterProyekContainer").hide(),ve(),console.log("Resetting kategori container..."),$("#filterKategoriTransaksiContainer").hide(),ye(),B(),f(1,{}),console.log("Filter reset completed successfully")}function F(){const e=$("#jenis_transaksi_id option:selected").text(),a=$("#jenis_keuangan_tefa_id option:selected").text();if(console.log("toggleKategoriTransaksiContainer called, jenisTransaksi:",e,"jenisKeuangan:",a),(e==="Pengeluaran"||e==="Pemasukan")&&(a==="Proyek"||a==="Non Proyek")){console.log("Attempting to load sub kategori for",e);const t=$("#jenis_transaksi_id").val(),i=$("#jenis_keuangan_tefa_id").val();t&&i&&_e(t,i)}else console.log("Hiding kategori - not both fields selected"),$("#kategoriTransaksiContainer").hide(),$("#sub_jenis_transaksi_id").prop("required",!1),U()}function I(){const e=$("#edit_jenis_transaksi_id option:selected").text(),a=$("#edit_jenis_keuangan_tefa_id option:selected").text();if(console.log("toggleEditKategoriTransaksiContainer called, jenisTransaksi:",e,"jenisKeuangan:",a),(e==="Pengeluaran"||e==="Pemasukan")&&(a==="Proyek"||a==="Non Proyek")){console.log("Attempting to load edit sub kategori for",e);const t=$("#edit_jenis_transaksi_id").val(),i=$("#edit_jenis_keuangan_tefa_id").val();t&&i&&X(t,i)}else console.log("Hiding edit kategori - not both fields selected"),$("#edit_kategoriTransaksiContainer").hide(),$("#edit_sub_jenis_transaksi_id").prop("required",!1),be()}function m(){const e=$("#filter_jenis_transaksi").val(),a=$("#filter_jenis_keuangan").val();console.log("Toggle filter kategori, jenisTransaksi:",e,"jenisKeuangan:",a),e&&a&&(e==="Pengeluaran"||e==="Pemasukan")?(console.log("Attempting to load filter sub kategori"),z()):(console.log("Hiding filter kategori container - not both fields selected"),$("#filterKategoriTransaksiContainer").hide(),$("#filter_sub_jenis_transaksi").val(""),$("label[for='filter_sub_jenis_transaksi']").text("Kategori Transaksi"))}function L(){$("#jenis_keuangan_tefa_id option:selected").text()==="Proyek"?($("#proyekContainer").show(),$("#proyek_id_selected").prop("required",!0)):($("#proyekContainer").hide(),$("#proyek_id_selected").prop("required",!1))}function N(){$("#edit_jenis_keuangan_tefa_id option:selected").text()==="Proyek"?($("#edit_proyekContainer").show(),$("#edit_proyek_id_selected").prop("required",!0)):($("#edit_proyekContainer").hide(),$("#edit_proyek_id_selected").prop("required",!1))}function x(){const e=$("#filter_jenis_keuangan").val();console.log("Toggle filter proyek container, jenisKeuangan:",e),e==="Proyek"?(console.log("Showing filter proyek container"),$("#filterProyekContainer").show(),$("#filter_proyek option").length<=1&&C()):(console.log("Hiding filter proyek container"),$("#filterProyekContainer").hide(),$("#filter_proyek").val(""),$.fn.select2&&$("#filter_proyek").hasClass("select2-hidden-accessible")&&$("#filter_proyek").val(null).trigger("change"))}function re(){if($.fn.select2)try{$("#proyek_id_selected, #sub_jenis_transaksi_id").each(function(){$(this).hasClass("select2-hidden-accessible")&&$(this).select2("destroy")}),$("#edit_proyek_id_selected, #edit_sub_jenis_transaksi_id").each(function(){$(this).hasClass("select2-hidden-accessible")&&$(this).select2("destroy")}),$("#proyek_id_selected").select2({theme:"bootstrap-5",width:"100%",placeholder:"Pilih Proyek",allowClear:!0,dropdownParent:$("#modalTambahKeuanganTefa")}),$("#sub_jenis_transaksi_id").select2({theme:"bootstrap-5",width:"100%",placeholder:"Pilih Kategori Transaksi",allowClear:!0,dropdownParent:$("#modalTambahKeuanganTefa")}),$("#edit_proyek_id_selected").select2({theme:"bootstrap-5",width:"100%",placeholder:"Pilih Proyek",allowClear:!0,dropdownParent:$("#modalEditKeuanganTefa")}),$("#edit_sub_jenis_transaksi_id").select2({theme:"bootstrap-5",width:"100%",placeholder:"Pilih Kategori Transaksi",allowClear:!0,dropdownParent:$("#modalEditKeuanganTefa")})}catch(e){console.warn("Error initializing Select2:",e)}else console.warn("Select2 library not loaded. Searchable dropdowns will not be available.")}function A(){E("#nominal"),E("#edit_nominal")}function J(){if($.fn.select2)try{$("#filter_proyek").hasClass("select2-hidden-accessible")&&$("#filter_proyek").select2("destroy"),$("#filter_sub_jenis_transaksi").hasClass("select2-hidden-accessible")&&$("#filter_sub_jenis_transaksi").select2("destroy"),$("#filter_proyek").select2({theme:"bootstrap-5",width:"100%",placeholder:"Pilih Proyek",allowClear:!0}),$("#filter_sub_jenis_transaksi").select2({theme:"bootstrap-5",width:"100%",placeholder:"Pilih Kategori Transaksi",allowClear:!0})}catch(e){console.warn("Error initializing Select2 for filters:",e)}else console.warn("Select2 library not loaded. Searchable dropdowns will not be available.")}function le(){const e=new Date,a=new Date(e.getFullYear(),e.getMonth(),1),t=new Date(e.getFullYear(),e.getMonth()+1,0),i=s=>{const n=s.getFullYear(),o=String(s.getMonth()+1).padStart(2,"0"),r=String(s.getDate()).padStart(2,"0");return`${n}-${o}-${r}`};$("#filter_tanggal_mulai").val(i(a)),$("#filter_tanggal_akhir").val(i(t)),C(),x(),m()}function de(){const e=new Date().toISOString().split("T")[0];$("#tanggal_transaksi").val(e),$("#keuangan_tefa_JsonData").val("[]"),$("#isSingleKeuanganTefa").val("1")}function ce(){$.ajax({url:"/koordinator/keuangan-tefa/jenis-keuangan-tefa",type:"GET",dataType:"json",beforeSend:function(){$("#jenis_keuangan_tefa_id").html('<option value="" disabled selected>Loading...</option>')},success:function(e){if(console.log("Response from jenis-keuangan-tefa:",e),e.success&&e.results){let a='<option value="" disabled selected>Pilih Keperluan Transaksi</option>';$.each(e.results,function(t,i){a+=`<option value="${i.jenis_keuangan_tefa_id}">${i.nama_jenis_keuangan_tefa}</option>`}),$("#jenis_keuangan_tefa_id").html(a)}else console.error("Error loading jenis keuangan:",e.message||"Unknown error"),$("#jenis_keuangan_tefa_id").html('<option value="" disabled selected>Error loading data</option>')},error:function(e,a,t){console.error("AJAX error details:",{url:"/koordinator/keuangan-tefa/jenis-keuangan-tefa",status:e.status,statusText:e.statusText,responseText:e.responseText,error:t}),$("#jenis_keuangan_tefa_id").html('<option value="" disabled selected>Error loading data</option>')}})}function ue(){$.ajax({url:"/koordinator/keuangan-tefa/jenis-transaksi",type:"GET",dataType:"json",beforeSend:function(){$("#jenis_transaksi_id").html('<option value="" disabled selected>Loading...</option>')},success:function(e){if(console.log("Response from jenis-transaksi API:",e),e.success&&e.data){let a='<option value="" disabled selected>Pilih Jenis Transaksi</option>';$.each(e.data,function(t,i){a+=`<option value="${i.jenis_transaksi_id}">${i.nama_jenis_transaksi}</option>`}),$("#jenis_transaksi_id").html(a)}else console.error("Error loading jenis transaksi:",e.message||"Unknown error"),$("#jenis_transaksi_id").html('<option value="" disabled selected>Error loading data</option>')},error:function(e,a,t){console.error("AJAX error details:",{status:e.status,statusText:e.statusText,responseText:e.responseText,error:t}),$("#jenis_transaksi_id").html('<option value="" disabled selected>Error loading data</option>')}})}function fe(){$.ajax({url:"/koordinator/keuangan-tefa/data-proyek",type:"GET",dataType:"json",beforeSend:function(){$("#proyek_id_selected").html('<option value="" disabled selected>Loading...</option>');try{$.fn.select2&&$("#proyek_id_selected").hasClass("select2-hidden-accessible")&&$("#proyek_id_selected").select2("destroy")}catch(e){console.warn("Error destroying Select2:",e)}},success:function(e){if(console.log("Response from proyek API:",e),e.success&&e.data){let a='<option value="" disabled selected>Pilih Proyek</option>';$.each(e.data,function(t,i){a+=`<option value="${i.proyek_id}">${i.nama_proyek}</option>`}),$("#proyek_id_selected").html(a);try{$.fn.select2&&$("#proyek_id_selected").select2({theme:"bootstrap-5",width:"100%",placeholder:"Pilih Proyek",allowClear:!0,dropdownParent:$("#modalTambahKeuanganTefa")})}catch(t){console.warn("Error initializing Select2 for proyek:",t)}}else console.error("Error loading proyek:",e.message||"Unknown error"),$("#proyek_id_selected").html('<option value="" disabled selected>Error loading data</option>')},error:function(e,a,t){console.error("AJAX error details:",{status:e.status,statusText:e.statusText,responseText:e.responseText,error:t}),$("#proyek_id_selected").html('<option value="" disabled selected>Error loading data</option>')}})}function _e(e,a){$.ajax({url:"/koordinator/keuangan-tefa/get-sub-jenis-transaksi",type:"GET",data:{jenis_transaksi_id:e,jenis_keuangan_tefa_id:a},dataType:"json",beforeSend:function(){$("#sub_jenis_transaksi_id").html('<option value="" disabled selected>Loading...</option>');try{$.fn.select2&&$("#sub_jenis_transaksi_id").hasClass("select2-hidden-accessible")&&$("#sub_jenis_transaksi_id").select2("destroy")}catch(t){console.warn("Error destroying Select2:",t)}},success:function(t){if(console.log("Response from get-sub-jenis-transaksi:",t),t.success&&t.results&&t.results.length>0){console.log("Found sub categories:",t.results.length),$("#kategoriTransaksiContainer").show();const i=$("#jenis_transaksi_id option:selected").text(),s=i==="Pengeluaran"?"Pilih Kategori Pengeluaran":"Pilih Kategori Pemasukan";let n=`<option value="" disabled selected>${s}</option>`;$.each(t.results,function(r,l){n+=`<option value="${l.id}">${l.text}</option>`}),$("#sub_jenis_transaksi_id").html(n),$("#sub_jenis_transaksi_id").prop("required",!0);const o=i==="Pengeluaran"?"Kategori Pengeluaran":"Kategori Pemasukan";$("label[for='sub_jenis_transaksi_id']").html(`${o} <span class="text-danger">*</span>`);try{$.fn.select2&&$("#sub_jenis_transaksi_id").select2({theme:"bootstrap-5",width:"100%",placeholder:s,allowClear:!0,dropdownParent:$("#modalTambahKeuanganTefa")})}catch(r){console.warn("Error initializing Select2 for sub jenis transaksi:",r)}}else console.log("No sub categories found - hiding container"),$("#kategoriTransaksiContainer").hide(),$("#sub_jenis_transaksi_id").prop("required",!1),$("#sub_jenis_transaksi_id").val(""),$("label[for='sub_jenis_transaksi_id']").text("Kategori Transaksi")},error:function(t,i,s){console.error("AJAX error details:",{status:t.status,statusText:t.statusText,responseText:t.responseText,error:s}),$("#kategoriTransaksiContainer").hide(),$("#sub_jenis_transaksi_id").prop("required",!1),$("#sub_jenis_transaksi_id").val("")}})}function C(){$.ajax({url:"/koordinator/keuangan-tefa/data-proyek",type:"GET",dataType:"json",beforeSend:function(){try{$.fn.select2&&$("#filter_proyek").hasClass("select2-hidden-accessible")&&$("#filter_proyek").select2("destroy")}catch(e){console.warn("Error destroying Select2:",e)}$("#filter_proyek").html('<option value="">Loading...</option>')},success:function(e){if(e.success&&e.data){let a='<option value="">Semua Proyek</option>';$.each(e.data,function(i,s){a+=`<option value="${s.proyek_id}">${s.nama_proyek}</option>`}),$("#filter_proyek").html(a);const t=localStorage.getItem("filter_proyek");t&&$("#filter_proyek").val(t),$.fn.select2&&$("#filter_proyek").select2({theme:"bootstrap-5",width:"100%",placeholder:"Pilih Proyek",allowClear:!0})}else $("#filter_proyek").html('<option value="">Error loading data</option>')},error:function(e,a,t){console.error("Error loading proyek data for filter:",t),$("#filter_proyek").html('<option value="">Error loading data</option>')}})}function z(){const e=$("#filter_jenis_transaksi").val(),a=$("#filter_jenis_keuangan").val();if(console.log("Loading sub jenis for filter:",e,a),e&&a){let t,i;$.ajax({url:"/koordinator/keuangan-tefa/jenis-transaksi",type:"GET",dataType:"json",async:!1,success:function(s){if(s.success&&s.data){const n=s.data.find(o=>o.nama_jenis_transaksi===e);n&&(t=n.jenis_transaksi_id)}}}),$.ajax({url:"/koordinator/keuangan-tefa/jenis-keuangan-tefa",type:"GET",dataType:"json",async:!1,success:function(s){if(s.success&&s.results){const n=s.results.find(o=>o.nama_jenis_keuangan_tefa===a);n&&(i=n.jenis_keuangan_tefa_id)}}}),t&&i&&$.ajax({url:"/koordinator/keuangan-tefa/get-sub-jenis-transaksi",type:"GET",data:{jenis_transaksi_id:t,jenis_keuangan_tefa_id:i},dataType:"json",beforeSend:function(){try{$.fn.select2&&$("#filter_sub_jenis_transaksi").hasClass("select2-hidden-accessible")&&$("#filter_sub_jenis_transaksi").select2("destroy")}catch(s){console.warn("Error destroying Select2:",s)}$("#filter_sub_jenis_transaksi").html('<option value="">Loading...</option>')},success:function(s){if(console.log("Filter - Sub jenis transaksi response:",s),s.success&&s.results&&s.results.length>0){console.log("Filter - Found sub categories:",s.results.length),$("#filterKategoriTransaksiContainer").show();let n='<option value="">Semua</option>';$.each(s.results,function(r,l){n+=`<option value="${l.id}">${l.text}</option>`}),$("#filter_sub_jenis_transaksi").html(n);const o=localStorage.getItem("filter_sub_jenis_transaksi");if(o&&$("#filter_sub_jenis_transaksi").val(o),$.fn.select2){const r=e==="Pengeluaran"?"Pilih Kategori Pengeluaran":"Pilih Kategori Pemasukan";$("#filter_sub_jenis_transaksi").select2({theme:"bootstrap-5",width:"100%",placeholder:r,allowClear:!0})}se()}else console.log("Filter - No sub categories found - hiding container"),$("#filterKategoriTransaksiContainer").hide(),$("#filter_sub_jenis_transaksi").val(""),$("label[for='filter_sub_jenis_transaksi']").text("Kategori Transaksi")},error:function(s,n,o){console.error("Filter - Error loading sub jenis transaksi:",o),$("#filterKategoriTransaksiContainer").hide(),$("#filter_sub_jenis_transaksi").val("")}})}else $("#filterKategoriTransaksiContainer").hide(),$("#filter_sub_jenis_transaksi").html('<option value="">Semua</option>'),$("#filter_sub_jenis_transaksi").val(""),$("label[for='filter_sub_jenis_transaksi']").text("Kategori Transaksi")}function f(e=1,a={}){$.ajax({url:"/koordinator/data-keuangan-tefa",type:"GET",data:{page:e,...a},dataType:"json",beforeSend:function(){$("#tableDataKeuanganTefa tbody").html(`<tr>
                    <td colspan="8" class="text-center">
                        <div class="spinner-border spinner-border-sm text-primary">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </td>
                </tr>`)},success:function(t){if(t.success){const i=t.keuanganTefa;if($("#tableDataKeuanganTefa tbody").empty(),i.data.length>0)$("#emptyDataKeuanganTefaMessage").addClass("d-none"),$.each(i.data,function(s,n){const r=new Date(n.tanggal_transaksi).toLocaleDateString("id-ID",{day:"2-digit",month:"2-digit",year:"numeric"}),l=new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(n.nominal_transaksi),d=new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(n.saldo);let u="";n.nama_jenis_transaksi==="Pemasukan"?u="badge bg-success":n.nama_jenis_transaksi==="Pengeluaran"&&(u="badge bg-danger");let g="";n.nama_jenis_keuangan_tefa==="Proyek"?g="<span>Proyek</span>":n.nama_jenis_keuangan_tefa==="Non Proyek"?g="<span>Non Proyek</span>":g=`<span>${n.nama_jenis_keuangan_tefa}</span>`;const h=j(n.nama_jenis_transaksi,3),b=j(n.nama_proyek,3),v=j(n.nama_transaksi,3);let y=`
                            <tr>
                                <td>${r}</td>
                                <td><span class="${u}">${h}</span></td>
                                <td>${g}</td>
                                <td>${n.nama_jenis_keuangan_tefa==="Proyek"&&b||"-"}</td>
                                <td>${v}</td>
                                <td>${l}</td>
                                <td>${d}</td>
                                <td>
                                    <div class="d-flex">
                                        <button type="button" class="btn btn-action-detail-keuangan" data-id="${n.keuangan_tefa_id}" data-bs-toggle="modal" data-bs-target="#modalEditKeuanganTefa">
                                            <svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M13.586 3.586C14.367 2.805 15.633 2.805 16.414 3.586L16.414 3.586C17.195 4.367 17.195 5.633 16.414 6.414L15.621 7.207L12.793 4.379L13.586 3.586Z" fill="#3C21F7"/>
                                                <path d="M11.379 5.793L3 14.172V17H5.828L14.207 8.621L11.379 5.793Z" fill="#3C21F7"/>
                                            </svg>
                                        </button>
                                        <button type="button" class="btn btn-action-delete" 
                                                data-id="${n.keuangan_tefa_id}">
                                            <svg width="20" height="20" viewBox="0 0 25 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path fill-rule="evenodd" clip-rule="evenodd" d="M21.5896 12.4848C21.5896 17.6563 17.459 21.8486 12.3636 21.8486C7.26829 21.8486 3.1377 17.6563 3.1377 12.4848C3.1377 7.31339 7.26829 3.12109 12.3636 3.12109C17.459 3.12109 21.5896 7.31339 21.5896 12.4848ZM7.56137 17.3588C7.17375 16.9654 7.17375 16.3276 7.56137 15.9342L10.9599 12.4848L7.56137 9.03551C7.17375 8.6421 7.17375 8.00426 7.56137 7.61085C7.94899 7.21744 8.57744 7.21744 8.96506 7.61085L12.3636 11.0602L15.7622 7.61085C16.1498 7.21744 16.7783 7.21744 17.1659 7.61085C17.5535 8.00426 17.5535 8.6421 17.1659 9.03551L13.7673 12.4848L17.1659 15.9342C17.5535 16.3276 17.5535 16.9654 17.1659 17.3588C16.7783 17.7522 16.1498 17.7522 15.7622 17.3588L12.3636 13.9095L8.96506 17.3588C8.57744 17.7522 7.94899 17.7522 7.56137 17.3588Z" fill="#E56F8C"/>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;$("#tableDataKeuanganTefa tbody").append(y)}),ge(i,a);else{const n=Object.keys(a).some(o=>a[o]!==""&&a[o]!==void 0)?'<p class="mb-0">Tidak ada data keuangan TEFA yang sesuai dengan filter yang dipilih.</p>':'<p class="mb-0">Tidak ada data keuangan TEFA yang tersedia.</p>';$("#emptyDataKeuanganTefaMessage").removeClass("d-none").find("div").html(n),$("#keuanganTefaPaginationInfo").text("Showing 0 to 0 of 0 entries"),$("#keuanganTefaPagination").empty()}_()}else $("#tableDataKeuanganTefa tbody").html('<tr><td colspan="8" class="text-center text-danger">Error loading data.</td></tr>'),console.error("Error in response:",t.message)},error:function(t,i,s){$("#tableDataKeuanganTefa tbody").html('<tr><td colspan="8" class="text-center text-danger">Failed to load data. Please try again.</td></tr>'),console.error("AJAX Error:",s)}})}function ge(e,a){const t=e.from||0,i=e.to||0,s=e.total||0;if($("#keuanganTefaPaginationInfo").text(`Showing ${t} to ${i} of ${s} entries`),$("#keuanganTefaPagination").empty(),e.total>0){let n='<ul class="pagination">';n+=`<li class="page-item ${e.current_page<=1?"disabled":""}">
            <a class="page-link keuangan-pagination-link" href="javascript:void(0)" data-page="${e.current_page-1}" data-filters='${JSON.stringify(a)}' aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
            </a>
        </li>`;for(let o=1;o<=e.last_page;o++)n+=`<li class="page-item ${e.current_page===o?"active":""}">
                <a class="page-link keuangan-pagination-link" href="javascript:void(0)" data-page="${o}" data-filters='${JSON.stringify(a)}'>${o}</a>
            </li>`;n+=`<li class="page-item ${e.current_page>=e.last_page?"disabled":""}">
            <a class="page-link keuangan-pagination-link" href="javascript:void(0)" data-page="${e.current_page+1}" data-filters='${JSON.stringify(a)}' aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
            </a>
        </li>`,n+="</ul>",$("#keuanganTefaPagination").html(n)}}function _(){$("#totalPemasukan").text("Loading..."),$("#totalPengeluaran").text("Loading..."),$("#saldoAkhir").text("Loading..."),console.log("Updating financial summary..."),$.ajax({url:"/koordinator/keuangan-tefa/get-summary",type:"GET",dataType:"json",success:function(e){if(console.log("Financial summary response:",e),e.success){const a=t=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0,maximumFractionDigits:0}).format(t);$("#totalPemasukan").text(a(e.total_pemasukan||0)),$("#totalPengeluaran").text(a(e.total_pengeluaran||0)),$("#saldoAkhir").text(a(e.saldo||0)),(e.saldo||0)<0?$("#saldoAkhir").removeClass("text-primary").addClass("text-danger"):$("#saldoAkhir").removeClass("text-danger").addClass("text-primary")}}})}function ke(){const e=localStorage.getItem("keuanganTefaFiltersApplied");if(!e)return;const a=new Date().getTime()-60*60*1e3;if(parseInt(e)<a){B();return}$("#formFilterKeuanganTefa").find("input, select").each(function(){const t=$(this).attr("id");if(t){const i=localStorage.getItem(t);i!==null&&$(this).val(i)}}),x(),m(),$("#filter_jenis_keuangan").val()==="Proyek"&&C(),$("#filter_jenis_transaksi").val()&&$("#filter_jenis_keuangan").val()&&z(),($("#filter_tanggal_mulai").val()||$("#filter_tanggal_akhir").val()||$("#filter_jenis_transaksi").val()||$("#filter_jenis_keuangan").val()||$("#filter_nama_transaksi").val()||$("#filter_proyek").val()||$("#filter_nominal_min").val()||$("#filter_nominal_max").val())&&setTimeout(function(){q()},500)}function B(){for(let e=0;e<localStorage.length;e++){const a=localStorage.key(e);a&&a.startsWith("filter_")&&localStorage.removeItem(a)}localStorage.removeItem("keuanganTefaFiltersApplied")}function pe(){if(!M())return $("#form_keuangan_tefa_error").removeClass("d-none alert-success").addClass("alert-danger").text("Harap periksa semua field yang wajib diisi."),!1;const e=Date.now().toString(),a=$("#jenis_transaksi_id option:selected").text(),t=$("#jenis_keuangan_tefa_id option:selected").text(),i=$("#nama_transaksi").val().trim(),s=$("#nominal").val(),n=$("#tanggal_transaksi").val(),o=Q(s),r=document.getElementById("file_keuangan_tefa");let l=null,d="";r.files&&r.files.length>0&&(l=r.files[0],d=r.files[0].name,console.log(`File "${d}" associated with item ${e}`));let u=JSON.parse($("#keuangan_tefa_JsonData").val());const g=u.length,h={id:e,sequence:g,jenis_transaksi_id:$("#jenis_transaksi_id").val(),jenis_transaksi_text:a,jenis_keuangan_tefa_id:$("#jenis_keuangan_tefa_id").val(),jenis_keuangan_text:t,proyek_id:$("#proyek_id_selected").val()||null,proyek_text:$("#proyek_id_selected option:selected").text()!=="Pilih Proyek"?$("#proyek_id_selected option:selected").text():"",sub_jenis_transaksi_id:$("#sub_jenis_transaksi_id").val()||null,sub_jenis_transaksi_text:$("#sub_jenis_transaksi_id option:selected").text()!=="Pilih Kategori Pengeluaran"?$("#sub_jenis_transaksi_id option:selected").text():"",nama_transaksi:i,tanggal_transaksi:n,nominal:s,deskripsi_transaksi:$("#deskripsi_transaksi").val(),has_file:!!l,file:l,fileName:d};u.push(h);const b=u.map(k=>{const{file:p,...H}=k;return H});$("#keuangan_tefa_JsonData").val(JSON.stringify(b)),window.keuanganTefaFiles||(window.keuanganTefaFiles={}),l&&(window.keuanganTefaFiles[e]=l),$("#isSingleKeuanganTefa").val("0"),$("#emptyRowKeuanganTefa").remove();const v=new Date(n).toLocaleDateString("id-ID"),y=`
        <tr id="item-${e}">
            <td>${i}</td>
            <td>${v}</td>
            <td>${a}</td>
            <td>${t}</td>
            <td class="text-end">${o}</td>
            <td>
                <button type="button" class="btn btn-sm btn-danger btn-remove-item" data-id="${e}">
                    <i class="bi bi-trash"></i> Hapus
                </button>
            </td>
        </tr>
    `;if($("#daftarKeuanganTefa").append(y),$(".is-invalid").removeClass("is-invalid"),$(".invalid-feedback").text(""),$("#nama_transaksi").val(""),$("#nominal").val(""),$("#deskripsi_transaksi").val(""),$("#file_keuangan_tefa").val(""),$("#file_preview_container").empty(),$.fn.select2)try{$("#proyek_id_selected, #sub_jenis_transaksi_id").each(function(){const k=$(this);if(k.hasClass("select2-hidden-accessible")){const p=k.data("select2");p&&(p.$container.removeClass("is-invalid"),p.$selection.removeClass("is-invalid"))}})}catch(k){console.warn("Error updating Select2 instances:",k)}return $("#form_keuangan_tefa_error").removeClass("d-none alert-danger").addClass("alert-success").text("Item berhasil ditambahkan ke daftar."),setTimeout(function(){$("#form_keuangan_tefa_error").addClass("d-none").removeClass("alert-success")},3e3),!0}function G(e){$.ajax({url:"/koordinator/keuangan-tefa/data-proyek",type:"GET",dataType:"json",beforeSend:function(){$("#edit_proyek_id_selected").html('<option value="" disabled selected>Loading...</option>'),$.fn.select2&&$("#edit_proyek_id_selected").data("select2")&&$("#edit_proyek_id_selected").select2("destroy")},success:function(a){if(a.success&&a.data){let t='<option value="" disabled>Pilih Proyek</option>';$.each(a.data,function(i,s){const n=s.proyek_id==e?"selected":"";t+=`<option value="${s.proyek_id}" ${n}>${s.nama_proyek}</option>`}),$("#edit_proyek_id_selected").html(t),$.fn.select2&&$("#edit_proyek_id_selected").select2({theme:"bootstrap-5",width:"100%",placeholder:"Pilih Proyek",allowClear:!0,dropdownParent:$("#modalEditKeuanganTefa")})}else console.error("Error loading proyek:",a.message||"Unknown error"),$("#edit_proyek_id_selected").html('<option value="" disabled selected>Error loading data</option>')},error:function(a){console.error("AJAX error details:",a),$("#edit_proyek_id_selected").html('<option value="" disabled selected>Error loading data</option>')}})}function X(e,a,t){$.ajax({url:"/koordinator/keuangan-tefa/get-sub-jenis-transaksi",type:"GET",data:{jenis_transaksi_id:e,jenis_keuangan_tefa_id:a},dataType:"json",beforeSend:function(){$("#edit_sub_jenis_transaksi_id").html('<option value="" disabled selected>Loading...</option>'),$.fn.select2&&$("#edit_sub_jenis_transaksi_id").data("select2")&&$("#edit_sub_jenis_transaksi_id").select2("destroy")},success:function(i){if(console.log("Edit form - Response from get-sub-jenis-transaksi:",i),i.success&&i.results&&i.results.length>0){console.log("Edit form - Found sub categories:",i.results.length),$("#edit_kategoriTransaksiContainer").show();const s=$("#edit_jenis_transaksi_id option:selected").text(),n=s==="Pengeluaran"?"Pilih Kategori Pengeluaran":"Pilih Kategori Pemasukan";let o=`<option value="" disabled>${n}</option>`;$.each(i.results,function(l,d){const u=d.id==t?"selected":"";o+=`<option value="${d.id}" ${u}>${d.text}</option>`}),$("#edit_sub_jenis_transaksi_id").html(o),$("#edit_sub_jenis_transaksi_id").prop("required",!0);const r=s==="Pengeluaran"?"Kategori Pengeluaran":"Kategori Pemasukan";$("label[for='edit_sub_jenis_transaksi_id']").html(`${r} <span class="text-danger">*</span>`),$.fn.select2&&$("#edit_sub_jenis_transaksi_id").select2({theme:"bootstrap-5",width:"100%",placeholder:n,allowClear:!0,dropdownParent:$("#modalEditKeuanganTefa")})}else console.log("Edit form - No sub categories found - hiding container"),$("#edit_kategoriTransaksiContainer").hide(),$("#edit_sub_jenis_transaksi_id").prop("required",!1),$("#edit_sub_jenis_transaksi_id").val(""),$("label[for='edit_sub_jenis_transaksi_id']").text("Kategori Transaksi")},error:function(i,s,n){console.error("Edit AJAX error details:",n),$("#edit_kategoriTransaksiContainer").hide(),$("#edit_sub_jenis_transaksi_id").prop("required",!1),$("#edit_sub_jenis_transaksi_id").val("")}})}function me(e){console.log("Loading keuangan tefa data for ID:",e),$("#formEditDataKeuanganTefa")[0].reset(),$("#form_keuangan_tefa_edit_error").addClass("d-none").text(""),$(".is-invalid").removeClass("is-invalid"),$("#edit_file_preview_container").remove();const a='<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Loading data...</p></div>',t=$("#formEditDataKeuanganTefa .modal-body").html();window.originalEditModalContent||(window.originalEditModalContent=t),$("#formEditDataKeuanganTefa .modal-body .row").html(a),$.ajax({url:`/koordinator/keuangan-tefa/${e}`,type:"GET",dataType:"json",success:function(i){if(i.success){const s=i.data;if(console.log("Loaded data:",s),$("#formEditDataKeuanganTefa .modal-body .row").find(".spinner-border").length>0&&window.originalEditModalContent){const n=document.createElement("div");n.innerHTML=window.originalEditModalContent;const o=$(n).find(".row").html();$("#formEditDataKeuanganTefa .modal-body .row").html(o)}$e(s)}else $("#formEditDataKeuanganTefa .modal-body .row").html(window.originalEditModalContent||t),$("#form_keuangan_tefa_edit_error").removeClass("d-none").text(i.message||"Failed to load data.")},error:function(i,s,n){console.error("AJAX Error:",n),$("#formEditDataKeuanganTefa .modal-body .row").html(window.originalEditModalContent||t),$("#form_keuangan_tefa_edit_error").removeClass("d-none").text("Error loading data. Please try again. "+n)}})}function $e(e){console.log("Populating edit form with data:",e),$("#keuangan_tefa_id").val(e.keuangan_tefa_id);const a=e.tanggal_transaksi;let t;a.includes("T")?t=a.split("T")[0]:a.includes(" ")?t=a.split(" ")[0]:t=a,$("#edit_tanggal_transaksi").val(t),$("#edit_nama_transaksi").val(e.nama_transaksi),$("#edit_deskripsi_transaksi").val(e.deskripsi_transaksi);const i=new Intl.NumberFormat("id-ID",{useGrouping:!0,maximumFractionDigits:0}).format(e.nominal_transaksi).replace(/,/g,".");if($("#edit_nominal").val(i),Promise.all([new Promise(s=>{$.ajax({url:"/koordinator/keuangan-tefa/jenis-transaksi",type:"GET",dataType:"json",success:function(n){if(n.success&&n.data){let o='<option value="" disabled>Pilih Jenis Transaksi</option>';$.each(n.data,function(r,l){const d=l.jenis_transaksi_id==e.jenis_transaksi_id?"selected":"";o+=`<option value="${l.jenis_transaksi_id}" ${d}>${l.nama_jenis_transaksi}</option>`}),$("#edit_jenis_transaksi_id").html(o),s()}else $("#edit_jenis_transaksi_id").html('<option value="" disabled selected>Error loading data</option>'),s()},error:function(){$("#edit_jenis_transaksi_id").html('<option value="" disabled selected>Error loading data</option>'),s()}})}),new Promise(s=>{$.ajax({url:"/koordinator/keuangan-tefa/jenis-keuangan-tefa",type:"GET",dataType:"json",success:function(n){if(n.success&&n.results){let o='<option value="" disabled>Pilih Keperluan Transaksi</option>';$.each(n.results,function(r,l){const d=l.jenis_keuangan_tefa_id==e.jenis_keuangan_tefa_id?"selected":"";o+=`<option value="${l.jenis_keuangan_tefa_id}" ${d}>${l.nama_jenis_keuangan_tefa}</option>`}),$("#edit_jenis_keuangan_tefa_id").html(o),s()}else $("#edit_jenis_keuangan_tefa_id").html('<option value="" disabled selected>Error loading data</option>'),s()},error:function(){$("#edit_jenis_keuangan_tefa_id").html('<option value="" disabled selected>Error loading data</option>'),s()}})})]).then(()=>{e.jenis_keuangan_tefa_id&&e.nama_jenis_keuangan_tefa==="Proyek"?($("#edit_proyekContainer").show(),G(e.proyek_id)):$("#edit_proyekContainer").hide(),e.jenis_transaksi_id&&(e.nama_jenis_transaksi==="Pengeluaran"||e.nama_jenis_transaksi==="Pemasukan")?($("#edit_kategoriTransaksiContainer").show(),e.jenis_transaksi_id&&e.jenis_keuangan_tefa_id&&X(e.jenis_transaksi_id,e.jenis_keuangan_tefa_id,e.sub_jenis_transaksi_id)):$("#edit_kategoriTransaksiContainer").hide()}),e.bukti_transaksi){const s="/"+e.bukti_transaksi,n=e.bukti_transaksi.split("/").pop();te(s,n)}$("#edit_file_keuangan_tefa").change(function(){w()&&O()})}function he(e){c.confirmationDelete("Apakah yakin ini mengahapus data ini? ").then(a=>{a.isConfirmed&&$.ajax({url:`/koordinator/keuangan-tefa/delete/${e}`,type:"DELETE",dataType:"json",beforeSend:function(){$(`button[data-id="${e}"]`).prop("disabled",!0)},success:function(t){t.success?(c.successMessage(t.message||"Data keuangan TEFA berhasil dihapus."),f(),_()):(c.errorMessage(t.message||"Gagal menghapus data."),$(`button[data-id="${e}"]`).prop("disabled",!1))},error:function(t,i,s){var o;console.error("Error deleting data:",s);const n=((o=t.responseJSON)==null?void 0:o.message)||"Terjadi kesalahan saat menghapus data.";c.errorMessage("Error",n),$(`button[data-id="${e}"]`).prop("disabled",!1)}})})}function U(){try{console.log("Resetting sub jenis transaksi dropdown..."),$.fn.select2&&$("#sub_jenis_transaksi_id").hasClass("select2-hidden-accessible")&&$("#sub_jenis_transaksi_id").select2("destroy"),$("#sub_jenis_transaksi_id").html('<option value="" disabled selected>Pilih Jenis Transaksi dan Keperluan terlebih dahulu</option>'),$("#sub_jenis_transaksi_id").val(""),$("label[for='sub_jenis_transaksi_id']").text("Kategori Transaksi"),$.fn.select2&&$("#sub_jenis_transaksi_id").select2({theme:"bootstrap-5",width:"100%",placeholder:"Pilih Kategori Transaksi",allowClear:!0,dropdownParent:$("#modalTambahKeuanganTefa")}),console.log("Sub jenis transaksi dropdown reset completed")}catch(e){console.warn("Error resetting sub jenis transaksi dropdown:",e),$("#sub_jenis_transaksi_id").html('<option value="" disabled selected>Pilih Jenis Transaksi dan Keperluan terlebih dahulu</option>').val(""),$("label[for='sub_jenis_transaksi_id']").text("Kategori Transaksi")}}function be(){try{$.fn.select2&&$("#edit_sub_jenis_transaksi_id").hasClass("select2-hidden-accessible")&&$("#edit_sub_jenis_transaksi_id").select2("destroy"),$("#edit_sub_jenis_transaksi_id").html('<option value="" disabled selected>Pilih Jenis Transaksi dan Keperluan terlebih dahulu</option>'),$.fn.select2&&$("#edit_sub_jenis_transaksi_id").select2({theme:"bootstrap-5",width:"100%",placeholder:"Pilih Kategori Transaksi",allowClear:!0,dropdownParent:$("#modalEditKeuanganTefa")})}catch(e){console.warn("Error resetting edit sub jenis transaksi dropdown:",e),$("#edit_sub_jenis_transaksi_id").html('<option value="" disabled selected>Pilih Jenis Transaksi dan Keperluan terlebih dahulu</option>')}}function ve(){try{console.log("Resetting filter proyek dropdown..."),$.fn.select2&&$("#filter_proyek").hasClass("select2-hidden-accessible")&&$("#filter_proyek").select2("destroy"),$("#filter_proyek").html('<option value="">Semua Proyek</option>'),$("#filter_proyek").val(""),$.fn.select2&&$("#filter_proyek").select2({theme:"bootstrap-5",width:"100%",placeholder:"Pilih Proyek",allowClear:!0}),console.log("Filter proyek dropdown reset completed")}catch(e){console.warn("Error resetting filter proyek dropdown:",e),$("#filter_proyek").html('<option value="">Semua Proyek</option>').val("")}}function ye(){try{console.log("Resetting filter sub jenis transaksi dropdown..."),$.fn.select2&&$("#filter_sub_jenis_transaksi").hasClass("select2-hidden-accessible")&&$("#filter_sub_jenis_transaksi").select2("destroy"),$("#filter_sub_jenis_transaksi").html('<option value="">Semua</option>'),$("#filter_sub_jenis_transaksi").val(""),$("label[for='filter_sub_jenis_transaksi']").text("Kategori Transaksi"),$.fn.select2&&$("#filter_sub_jenis_transaksi").select2({theme:"bootstrap-5",width:"100%",placeholder:"Pilih Kategori Transaksi",allowClear:!0}),console.log("Filter sub jenis transaksi dropdown reset completed")}catch(e){console.warn("Error resetting filter sub jenis dropdown:",e),$("#filter_sub_jenis_transaksi").html('<option value="">Semua</option>').val(""),$("label[for='filter_sub_jenis_transaksi']").text("Kategori Transaksi")}}function V(){console.log("Resetting form tambah data after successful save..."),$("#formTambahDataKeuanganTefa")[0].reset();const e=new Date().toISOString().split("T")[0];$("#tanggal_transaksi").val(e),console.log("Tanggal transaksi set to today:",e),$(".is-invalid").removeClass("is-invalid"),$(".invalid-feedback").text(""),$("#form_keuangan_tefa_error").addClass("d-none").text(""),$("#proyekContainer").hide(),$("#proyek_id_selected").prop("required",!1),je(),$("#kategoriTransaksiContainer").hide(),$("#sub_jenis_transaksi_id").prop("required",!1),U(),$("#file_keuangan_tefa").val(""),$("#file_preview_container").empty(),window.keuanganTefaFiles&&(window.keuanganTefaFiles={}),$("#keuangan_tefa_JsonData").val("[]"),$("#daftarKeuanganTefa").html('<tr id="emptyRowKeuanganTefa"><td colspan="6" class="text-center">Belum ada keuangan tefa yang ditambahkan ke daftar</td></tr>'),$("#isSingleKeuanganTefa").val("1"),$("#btnSimpanKeuanganTefa").prop("disabled",!1).html("Simpan Data"),console.log("Form reset completed - ready for new entry")}function je(){try{console.log("Resetting proyek dropdown..."),$.fn.select2&&$("#proyek_id_selected").hasClass("select2-hidden-accessible")&&$("#proyek_id_selected").select2("destroy"),$("#proyek_id_selected").html('<option value="" disabled selected>Pilih Proyek</option>'),$("#proyek_id_selected").val(""),$.fn.select2&&$("#proyek_id_selected").select2({theme:"bootstrap-5",width:"100%",placeholder:"Pilih Proyek",allowClear:!0,dropdownParent:$("#modalTambahKeuanganTefa")}),console.log("Proyek dropdown reset completed")}catch(e){console.warn("Error resetting proyek dropdown:",e),$("#proyek_id_selected").html('<option value="" disabled selected>Pilih Proyek</option>').val("")}}
