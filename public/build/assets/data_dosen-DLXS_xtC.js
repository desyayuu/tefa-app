document.addEventListener("DOMContentLoaded",function(){h(),S(),w()});function h(){document.querySelectorAll(".alert-dismissible").forEach(function(i){setTimeout(function(){new bootstrap.Alert(i).close()},3e3)})}function x(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}function y(e){return e.querySelectorAll('input[type="date"]').forEach(a=>{if(a.value===""){const n=a.getAttribute("name");a.setAttribute("data-original-name",n),a.removeAttribute("name")}}),!0}function g(e){if(e.value.trim()){e.classList.remove("is-invalid");const i=e.nextElementSibling;return i&&i.classList.contains("invalid-feedback")&&(i.textContent=""),!0}else{e.classList.add("is-invalid");const i=e.nextElementSibling;if(i&&i.classList.contains("invalid-feedback"))i.textContent="Nama dosen wajib diisi";else{const a=document.createElement("div");a.classList.add("invalid-feedback"),a.textContent="Nama dosen wajib diisi",e.parentNode.appendChild(a)}return!1}}function v(e){const i=e.value.trim();if(!i){e.classList.add("is-invalid");const n=e.nextElementSibling;if(n&&n.classList.contains("invalid-feedback"))n.textContent="NIDN/NIP wajib diisi";else{const t=document.createElement("div");t.classList.add("invalid-feedback"),t.textContent="NIDN/NIP wajib diisi",e.parentNode.appendChild(t)}return!1}if(!/^\d{10}$/.test(i)){e.classList.add("is-invalid");const n=e.nextElementSibling;if(n&&n.classList.contains("invalid-feedback"))n.textContent="NIDN harus berupa angka dan tepat 10 digit";else{const t=document.createElement("div");t.classList.add("invalid-feedback"),t.textContent="NIDN harus berupa angka dan tepat 10 digit",e.parentNode.appendChild(t)}return!1}e.classList.remove("is-invalid");const a=e.nextElementSibling;return a&&a.classList.contains("invalid-feedback")&&(a.textContent=""),!0}function b(e){const i=e.value.trim();if(!i){e.classList.add("is-invalid");const n=e.nextElementSibling;if(n&&n.classList.contains("invalid-feedback"))n.textContent="Email wajib diisi";else{const t=document.createElement("div");t.classList.add("invalid-feedback"),t.textContent="Email wajib diisi",e.parentNode.appendChild(t)}return!1}if(!x(i)){e.classList.add("is-invalid");const n=e.nextElementSibling;if(n&&n.classList.contains("invalid-feedback"))n.textContent="Format email tidak valid";else{const t=document.createElement("div");t.classList.add("invalid-feedback"),t.textContent="Format email tidak valid",e.parentNode.appendChild(t)}return!1}e.classList.remove("is-invalid");const a=e.nextElementSibling;return a&&a.classList.contains("invalid-feedback")&&(a.textContent=""),!0}async function p(e,i,a){const n=e.value.trim();if(n===a){e.classList.remove("is-invalid");const t=e.nextElementSibling;return t&&t.classList.contains("invalid-feedback")&&(t.textContent=""),!0}if(!v(e))return!1;try{const t=new FormData;t.append("nidn_dosen",n),t.append("dosen_id",i),t.append("_token",document.querySelector('meta[name="csrf-token"]').getAttribute("content")),e.classList.add("is-loading");const s=await fetch("/dosen/profil/check-email-nidn-exists",{method:"POST",body:t});if(e.classList.remove("is-loading"),!s.ok)throw new Error("Network response was not ok");if((await s.json()).nidnExists){e.classList.add("is-invalid");const o=e.nextElementSibling;if(o&&o.classList.contains("invalid-feedback"))o.textContent="NIDN sudah terdaftar dalam sistem.";else{const c=document.createElement("div");c.classList.add("invalid-feedback"),c.textContent="NIDN sudah terdaftar dalam sistem.",e.parentNode.appendChild(c)}return!1}else{e.classList.remove("is-invalid");const o=e.nextElementSibling;return o&&o.classList.contains("invalid-feedback")&&(o.textContent=""),!0}}catch(t){console.error("Error validating NIDN:",t),e.classList.remove("is-loading"),e.classList.add("is-invalid");const s=e.nextElementSibling;if(s&&s.classList.contains("invalid-feedback"))s.textContent="Gagal memeriksa NIDN. Silakan coba lagi.";else{const l=document.createElement("div");l.classList.add("invalid-feedback"),l.textContent="Gagal memeriksa NIDN. Silakan coba lagi.",e.parentNode.appendChild(l)}return!1}}async function C(e,i,a){const n=e.value.trim();if(n===a){e.classList.remove("is-invalid");const t=e.nextElementSibling;return t&&t.classList.contains("invalid-feedback")&&(t.textContent=""),!0}if(!b(e))return!1;try{const t=new FormData;t.append("email_dosen",n),t.append("dosen_id",i),t.append("_token",document.querySelector('meta[name="csrf-token"]').getAttribute("content")),e.classList.add("is-loading");const s=await fetch("/dosen/profil/check-email-nidn-exists",{method:"POST",body:t});if(e.classList.remove("is-loading"),!s.ok)throw new Error("Network response was not ok");if((await s.json()).emailExists){e.classList.add("is-invalid");const o=e.nextElementSibling;if(o&&o.classList.contains("invalid-feedback"))o.textContent="Email sudah terdaftar dalam sistem.";else{const c=document.createElement("div");c.classList.add("invalid-feedback"),c.textContent="Email sudah terdaftar dalam sistem.",e.parentNode.appendChild(c)}return!1}else{e.classList.remove("is-invalid");const o=e.nextElementSibling;return o&&o.classList.contains("invalid-feedback")&&(o.textContent=""),!0}}catch(t){console.error("Error validating email:",t),e.classList.remove("is-loading"),e.classList.add("is-invalid");const s=e.nextElementSibling;if(s&&s.classList.contains("invalid-feedback"))s.textContent="Gagal memeriksa email. Silakan coba lagi.";else{const l=document.createElement("div");l.classList.add("invalid-feedback"),l.textContent="Gagal memeriksa email. Silakan coba lagi.",e.parentNode.appendChild(l)}return!1}}function S(){document.querySelectorAll('form[id^="form_edit_"]').forEach(i=>{const a=i.id.replace("form_edit_",""),n=document.getElementById(`edit_form_error_${a}`),t=document.getElementById(`modalDosen${a}`);t&&(t.addEventListener("show.bs.modal",function(){console.log(`Modal ${t.id} fully shown`),i.querySelectorAll('input:not([type="file"]), select, textarea').forEach(r=>{r.setAttribute("data-original-value",r.value)})}),t.addEventListener("show.bs.modal",function(){console.log(`Modal ${t.id} opening`),L(i)}));const s=document.getElementById(`nama_dosen_${a}`),l=document.getElementById(`nidn_dosen_${a}`),o=document.getElementById(`email_dosen_${a}`);s&&s.addEventListener("blur",function(){g(s)}),l&&l.addEventListener("blur",function(){v(l)}),o&&o.addEventListener("blur",function(){b(o)}),i.addEventListener("submit",async function(c){c.preventDefault(),n&&(n.classList.add("d-none"),n.textContent=""),E(i);const r=i.querySelector('button[type="submit"]');r&&(r.disabled=!0,r.innerHTML='<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Menyimpan...');let f=!0;if(s){const d=g(s);f=f&&d}if(l&&l.value!==l.getAttribute("data-original-value")){let d=v(l);d&&(d=await p(l,a,l.getAttribute("data-original-value"))),f=f&&d}if(o&&o.value!==o.getAttribute("data-original-value")){let d=b(o);d&&(d=await C(o,a,o.getAttribute("data-original-value"))),f=f&&d}if(!f){r&&(r.disabled=!1,r.innerHTML="Simpan Perubahan"),n&&(n.textContent="Mohon periksa kembali data yang dimasukkan.",n.classList.remove("d-none"));const d=i.querySelector(".is-invalid");d&&(d.scrollIntoView({behavior:"smooth",block:"center"}),d.focus());return}y(i);const k=new FormData(i);try{const d=await fetch(i.action,{method:"POST",body:k,headers:{"X-Requested-With":"XMLHttpRequest"}}),m=await d.json();d.ok?window.location.reload():(m.errors?N(i,m.errors,a):n&&(n.textContent=m.message||"Terjadi kesalahan saat menyimpan data.",n.classList.remove("d-none")),r&&(r.disabled=!1,r.innerHTML="Simpan Perubahan"))}catch(d){console.error("Error submitting form:",d),n&&(n.textContent="Terjadi kesalahan saat menyimpan data. Silakan coba lagi.",n.classList.remove("d-none")),r&&(r.disabled=!1,r.innerHTML="Simpan Perubahan")}})})}function E(e){e.querySelectorAll(".is-invalid").forEach(a=>{a.classList.remove("is-invalid");const n=a.nextElementSibling;n&&n.classList.contains("invalid-feedback")&&(n.textContent="")})}function N(e,i,a){for(const s in i){const l=`${s}_${a}`,o=document.getElementById(l);if(o){o.classList.add("is-invalid");const c=o.nextElementSibling;if(c&&c.classList.contains("invalid-feedback"))c.textContent=Array.isArray(i[s])?i[s][0]:i[s];else{const r=document.createElement("div");r.classList.add("invalid-feedback"),r.textContent=Array.isArray(i[s])?i[s][0]:i[s],o.parentNode.appendChild(r)}}}const n=document.getElementById(`edit_form_error_${a}`);n&&(n.textContent="Terdapat kesalahan pada form. Mohon periksa kembali data yang dimasukkan.",n.classList.remove("d-none"));const t=e.querySelector(".is-invalid");t&&(t.scrollIntoView({behavior:"smooth",block:"center"}),t.focus())}function w(){document.querySelectorAll('.modal[id^="modalDosen"]').forEach(i=>{i.id.replace("modalDosen","");const a=i.querySelector("form");i.addEventListener("show.bs.modal",function(){console.log(`Modal ${i.id} opened - storing original values`),L(a)});const n=i.querySelector("button.btn-tutup");n&&n.addEventListener("click",function(){console.log(`Cancel button clicked in modal ${i.id}`),u(a)});const t=i.querySelector("button.btn-close");t&&t.addEventListener("click",function(){console.log(`Close button clicked in modal ${i.id}`),u(a)}),i.addEventListener("hidden.bs.modal",function(){console.log(`Modal ${i.id} hidden`),u(a)})})}function L(e){e._originalValues={},e.querySelectorAll('input:not([type="file"]), select, textarea').forEach(a=>{const n=a.id;e._originalValues[n]=a.value,a.setAttribute("data-original-value",a.value),console.log(`Stored original value for ${n}: ${a.value}`)})}function u(e){console.log("Resetting form to original values"),e._originalValues?e.querySelectorAll('input:not([type="file"]), select, textarea').forEach(s=>{const l=s.id;if(e._originalValues[l]!==void 0)s.value=e._originalValues[l],console.log(`Reset ${l} to ${e._originalValues[l]}`);else{const o=s.getAttribute("data-original-value");o!=null&&(s.value=o,console.log(`Reset ${l} to ${o} (from attribute)`))}}):e.querySelectorAll('input:not([type="file"]), select, textarea').forEach(s=>{const l=s.getAttribute("data-original-value");l!=null&&(s.value=l,console.log(`Reset ${s.id} to ${l} (from attribute)`))}),e.querySelectorAll('input[type="file"]').forEach(t=>{t.value=""}),e.querySelectorAll('input[type="password"]').forEach(t=>{t.value=""}),E(e);const n=e.querySelector(".alert-danger");n&&(n.classList.add("d-none"),n.textContent="")}
